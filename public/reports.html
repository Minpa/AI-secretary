<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Secretary - ë¦¬í¬íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-white text-xl font-bold">AI Secretary</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">í™ˆ</a>
                    <a href="/dashboard" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">ëŒ€ì‹œë³´ë“œ</a>
                    <a href="/test" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">í…ŒìŠ¤íŠ¸</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ìš´ì˜ ë¦¬í¬íŠ¸</h1>
            <p class="mt-2 text-gray-600">ì ‘ìˆ˜ í˜„í™© ë¶„ì„ ë° í†µê³„ ë¦¬í¬íŠ¸</p>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">í•„í„° ì„¤ì •</h2>
            </div>
            <div class="px-6 py-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Date Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ê¸°ê°„ ì„¤ì •</label>
                        <div class="space-y-2">
                            <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>

                    <!-- Channel Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì ‘ìˆ˜ ì±„ë„</label>
                        <select id="channelFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">ì „ì²´ ì±„ë„</option>
                            <option value="sms">ğŸ“± SMS</option>
                            <option value="email">ğŸ“§ ì´ë©”ì¼</option>
                            <option value="web">ğŸŒ ì›¹í¼</option>
                            <option value="call">ğŸ“ í†µí™”</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì²˜ë¦¬ ìƒíƒœ</label>
                        <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">ì „ì²´ ìƒíƒœ</option>
                            <option value="pending">ëŒ€ê¸°ì¤‘</option>
                            <option value="classified">ë¶„ë¥˜ì™„ë£Œ</option>
                            <option value="assigned">í• ë‹¹ë¨</option>
                            <option value="processed">ì²˜ë¦¬ì™„ë£Œ</option>
                        </select>
                    </div>

                    <!-- Priority Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìš°ì„ ìˆœìœ„</label>
                        <select id="priorityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">ì „ì²´ ìš°ì„ ìˆœìœ„</option>
                            <option value="urgent">ê¸´ê¸‰</option>
                            <option value="high">ë†’ìŒ</option>
                            <option value="medium">ë³´í†µ</option>
                            <option value="low">ë‚®ìŒ</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-2 items-center">
                    <button id="loadData" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
                        ğŸ“Š ë°ì´í„° ë¡œë“œ
                    </button>
                    <span id="dataStatus" class="text-sm text-gray-500 hidden">
                        â³ ë°ì´í„° ë¡œë”© ì¤‘...
                    </span>
                    <button id="applyFilters" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        í•„í„° ì ìš©
                    </button>
                    <button id="resetFilters" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                        ì´ˆê¸°í™”
                    </button>
                    <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        CSV ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button id="testWordCloud" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        ğŸ”¤ ì›Œë“œí´ë¼ìš°ë“œ í…ŒìŠ¤íŠ¸
                    </button>
                    <button id="debugLibraries" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                        ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ í™•ì¸
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">ğŸ“¨</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">ì´ ì ‘ìˆ˜</dt>
                                <dd class="text-lg font-medium text-gray-900" id="totalMessages">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">âœ…</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">ì²˜ë¦¬ì™„ë£Œ</dt>
                                <dd class="text-lg font-medium text-gray-900" id="processedMessages">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">â³</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">í‰ê·  ì²˜ë¦¬ì‹œê°„</dt>
                                <dd class="text-lg font-medium text-gray-900" id="avgProcessingTime">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">ğŸ¯</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">SLA ì¤€ìˆ˜ìœ¨</dt>
                                <dd class="text-lg font-medium text-gray-900" id="slaCompliance">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Cloud -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">ì£¼ìš” í‚¤ì›Œë“œ ë¶„ì„</h3>
                <p class="text-sm text-gray-500 mt-1">ì ‘ìˆ˜ëœ ìš”ì²­ì—ì„œ ê°€ì¥ ìì£¼ ì–¸ê¸‰ë˜ëŠ” í‚¤ì›Œë“œë“¤</p>
            </div>
            <div class="p-6">
                <div class="flex justify-center">
                    <canvas id="wordCloud" width="800" height="400" style="max-width: 100%; height: 400px;"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <div id="wordCloudStats" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-blue-200">
                <h3 class="text-lg font-medium text-blue-900 flex items-center">
                    ğŸ¤– AI ì¸ì‚¬ì´íŠ¸
                    <span class="ml-2 text-sm font-normal text-blue-600">í‚¤ì›Œë“œ ë¶„ì„ ê¸°ë°˜ ìë™ ìƒì„±</span>
                </h3>
            </div>
            <div class="p-6">
                <div id="aiInsights" class="space-y-3">
                    <div class="text-center text-blue-600">í‚¤ì›Œë“œë¥¼ ë¶„ì„í•˜ì—¬ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Channel Distribution -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">ì±„ë„ë³„ ì ‘ìˆ˜ í˜„í™©</h3>
                </div>
                <div class="p-6">
                    <canvas id="channelChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Status Distribution -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">ìƒíƒœë³„ ë¶„í¬</h3>
                </div>
                <div class="p-6">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Priority Distribution -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">ìš°ì„ ìˆœìœ„ë³„ ë¶„í¬</h3>
                </div>
                <div class="p-6">
                    <canvas id="priorityChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Daily Trend -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">ì¼ë³„ ì ‘ìˆ˜ ì¶”ì´</h3>
                </div>
                <div class="p-6">
                    <canvas id="trendChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Keyword Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Top Keywords -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">ìƒìœ„ í‚¤ì›Œë“œ ìˆœìœ„</h3>
                    <p class="text-sm text-gray-500 mt-1">ê°€ì¥ ìì£¼ ì–¸ê¸‰ë˜ëŠ” í‚¤ì›Œë“œ TOP 10</p>
                </div>
                <div class="p-6">
                    <div id="topKeywords" class="space-y-3">
                        <div class="text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- Category Keywords -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">ì¹´í…Œê³ ë¦¬ë³„ ì£¼ìš” í‚¤ì›Œë“œ</h3>
                    <p class="text-sm text-gray-500 mt-1">ë¶„ì•¼ë³„ ìì£¼ ì–¸ê¸‰ë˜ëŠ” í‚¤ì›Œë“œ</p>
                </div>
                <div class="p-6">
                    <div id="categoryKeywords" class="space-y-4">
                        <div class="text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Data Table -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">ìƒì„¸ ë°ì´í„°</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì ‘ìˆ˜ì¼ì‹œ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì±„ë„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë‚´ìš©</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìš°ì„ ìˆœìœ„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë¶„ë¥˜</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let charts = {};
        let wordCloudInstance = null;

        // Wait for libraries to load
        function waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max wait time
                
                const checkLibraries = () => {
                    attempts++;
                    const chartReady = typeof Chart !== 'undefined';
                    const wordCloudReady = typeof WordCloud !== 'undefined';
                    
                    console.log(`ğŸ“š Attempt ${attempts}: Chart.js available:`, chartReady, ', WordCloud available:', wordCloudReady);
                    
                    if (chartReady && wordCloudReady) {
                        console.log('âœ… All libraries loaded successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.log('â° Timeout waiting for libraries');
                        reject(new Error('Timeout waiting for libraries to load'));
                    } else {
                        setTimeout(checkLibraries, 100);
                    }
                };
                checkLibraries();
            });
        }

        // Initialize date inputs with default values
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Reports page loaded');
            
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Wait for libraries to load before initializing
            try {
                await waitForLibraries();
                loadReportData();
            } catch (error) {
                console.error('âŒ Error loading libraries:', error);
                console.log('ğŸ”„ Loading data anyway with fallback displays');
                
                // Show error message to user but still load data
                const wordCloudCanvas = document.getElementById('wordCloud');
                const ctx = wordCloudCanvas.getContext('2d');
                ctx.fillStyle = '#EF4444';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨ - ê¸°ë³¸ í‘œì‹œ ì‚¬ìš©', wordCloudCanvas.width / 2, wordCloudCanvas.height / 2);
                
                // Still load the data for statistics and table
                loadReportData();
            }
        });

        // Load report data
        async function loadReportData() {
            try {
                console.log('ğŸš€ Loading report data...');
                
                // Show loading status
                const statusEl = document.getElementById('dataStatus');
                statusEl.textContent = 'â³ ë°ì´í„° ë¡œë”© ì¤‘...';
                statusEl.className = 'text-sm text-blue-600';
                statusEl.classList.remove('hidden');
                
                // Get filter values
                const filters = getFilterValues();
                console.log('ğŸ” Filters:', filters);
                
                // Load messages data (request more messages for better analysis)
                const messagesResponse = await fetch('/api/intake/messages?limit=1000');
                console.log('ğŸ“¡ Messages response status:', messagesResponse.status);
                
                const messagesData = await messagesResponse.json();
                console.log('ğŸ“Š Messages data:', messagesData);
                
                if (messagesData.success) {
                    currentData = messagesData.data;
                    console.log('âœ… Loaded', currentData.length, 'messages');
                    
                    // Apply filters
                    const filteredData = applyFilters(currentData, filters);
                    console.log('ğŸ” Filtered to', filteredData.length, 'messages');
                    
                    // Update statistics
                    try {
                        updateStatistics(filteredData);
                        console.log('âœ… Statistics updated');
                    } catch (error) {
                        console.error('âŒ Error updating statistics:', error);
                    }
                    
                    // Update charts
                    try {
                        updateCharts(filteredData);
                        console.log('âœ… Charts updated');
                    } catch (error) {
                        console.error('âŒ Error updating charts:', error);
                    }
                    
                    // Update word cloud
                    try {
                        updateWordCloud(filteredData);
                        console.log('âœ… Word cloud updated');
                    } catch (error) {
                        console.error('âŒ Error updating word cloud:', error);
                    }
                    
                    // Update table
                    try {
                        updateDataTable(filteredData);
                        console.log('âœ… Data table updated');
                    } catch (error) {
                        console.error('âŒ Error updating data table:', error);
                    }
                    
                    // Show success status
                    const statusEl = document.getElementById('dataStatus');
                    statusEl.textContent = `âœ… ${filteredData.length}ê°œ ë©”ì‹œì§€ ë¡œë“œ ì™„ë£Œ`;
                    statusEl.className = 'text-sm text-green-600';
                } else {
                    console.error('âŒ Failed to load messages:', messagesData);
                    const statusEl = document.getElementById('dataStatus');
                    statusEl.textContent = 'âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
                    statusEl.className = 'text-sm text-red-600';
                }
                
                // Load SLA data
                const slaResponse = await fetch('/api/tickets/sla/dashboard');
                if (slaResponse.ok) {
                    const slaData = await slaResponse.json();
                    if (slaData.success) {
                        document.getElementById('slaCompliance').textContent = (slaData.data.slaPerformance || 0).toFixed(1) + '%';
                    }
                }
                
            } catch (error) {
                console.error('Error loading report data:', error);
                const statusEl = document.getElementById('dataStatus');
                statusEl.textContent = 'âŒ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ';
                statusEl.className = 'text-sm text-red-600';
            }
        }

        function getFilterValues() {
            return {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                channel: document.getElementById('channelFilter').value,
                status: document.getElementById('statusFilter').value,
                priority: document.getElementById('priorityFilter').value
            };
        }

        function applyFilters(data, filters) {
            return data.filter(item => {
                const itemDate = new Date(item.createdAt).toISOString().split('T')[0];
                
                // Date range filter
                if (filters.startDate && itemDate < filters.startDate) return false;
                if (filters.endDate && itemDate > filters.endDate) return false;
                
                // Channel filter
                if (filters.channel && item.channel !== filters.channel) return false;
                
                // Status filter
                if (filters.status && item.status !== filters.status) return false;
                
                // Priority filter
                if (filters.priority && item.priority !== filters.priority) return false;
                
                return true;
            });
        }

        function updateStatistics(data) {
            document.getElementById('totalMessages').textContent = data.length;
            
            const processedCount = data.filter(item => item.status === 'processed').length;
            document.getElementById('processedMessages').textContent = processedCount;
            
            // Calculate average processing time (placeholder)
            document.getElementById('avgProcessingTime').textContent = '2.5ì‹œê°„';
        }

        function updateCharts(data) {
            if (typeof Chart !== 'undefined') {
                console.log('ğŸ“Š Using Chart.js for charts');
                updateChannelChart(data);
                updateStatusChart(data);
                updatePriorityChart(data);
                updateTrendChart(data);
            } else {
                console.log('ğŸ“Š Using fallback charts (Chart.js not available)');
                updateFallbackCharts(data);
            }
        }
        
        function updateFallbackCharts(data) {
            // Create simple HTML-based charts as fallback
            updateFallbackChannelChart(data);
            updateFallbackStatusChart(data);
            updateFallbackPriorityChart(data);
            updateFallbackTrendChart(data);
        }
        
        function updateFallbackChannelChart(data) {
            const channelCounts = {};
            data.forEach(item => {
                channelCounts[item.channel] = (channelCounts[item.channel] || 0) + 1;
            });
            
            const canvas = document.getElementById('channelChart');
            const container = canvas.parentElement;
            
            // Replace canvas with HTML chart
            container.innerHTML = `
                <div class="space-y-3">
                    ${Object.entries(channelCounts).map(([channel, count]) => {
                        const percentage = (count / data.length * 100).toFixed(1);
                        const channelNames = { sms: 'SMS', email: 'ì´ë©”ì¼', web: 'ì›¹í¼', call: 'í†µí™”' };
                        const colors = { sms: 'bg-blue-500', email: 'bg-green-500', web: 'bg-yellow-500', call: 'bg-red-500' };
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${channelNames[channel] || channel}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="${colors[channel] || 'bg-gray-500'} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}ê±´ (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function updateFallbackStatusChart(data) {
            const statusCounts = {};
            data.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });
            
            const canvas = document.getElementById('statusChart');
            const container = canvas.parentElement;
            const statusLabels = { pending: 'ëŒ€ê¸°ì¤‘', classified: 'ë¶„ë¥˜ì™„ë£Œ', assigned: 'í• ë‹¹ë¨', processed: 'ì²˜ë¦¬ì™„ë£Œ' };
            const statusColors = { pending: 'bg-gray-500', classified: 'bg-blue-500', assigned: 'bg-purple-500', processed: 'bg-green-500' };
            
            container.innerHTML = `
                <div class="space-y-3">
                    ${Object.entries(statusCounts).map(([status, count]) => {
                        const percentage = (count / data.length * 100).toFixed(1);
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${statusLabels[status] || status}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="${statusColors[status] || 'bg-gray-500'} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}ê±´ (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function updateFallbackPriorityChart(data) {
            const priorityCounts = {};
            data.forEach(item => {
                priorityCounts[item.priority] = (priorityCounts[item.priority] || 0) + 1;
            });
            
            const canvas = document.getElementById('priorityChart');
            const container = canvas.parentElement;
            const priorityLabels = { urgent: 'ê¸´ê¸‰', high: 'ë†’ìŒ', medium: 'ë³´í†µ', low: 'ë‚®ìŒ' };
            const priorityColors = { urgent: 'bg-red-500', high: 'bg-orange-500', medium: 'bg-yellow-500', low: 'bg-green-500' };
            
            container.innerHTML = `
                <div class="space-y-3">
                    ${Object.entries(priorityCounts).map(([priority, count]) => {
                        const percentage = (count / data.length * 100).toFixed(1);
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${priorityLabels[priority] || priority}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="${priorityColors[priority] || 'bg-gray-500'} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}ê±´ (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function updateFallbackTrendChart(data) {
            const dailyCounts = {};
            data.forEach(item => {
                const date = new Date(item.createdAt).toISOString().split('T')[0];
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            const canvas = document.getElementById('trendChart');
            const container = canvas.parentElement;
            const sortedDates = Object.keys(dailyCounts).sort().slice(-7); // Last 7 days
            const maxCount = Math.max(...Object.values(dailyCounts));
            
            container.innerHTML = `
                <div class="space-y-2">
                    ${sortedDates.map(date => {
                        const count = dailyCounts[date] || 0;
                        const percentage = maxCount > 0 ? (count / maxCount * 100) : 0;
                        const dateStr = new Date(date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${dateStr}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="bg-purple-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}ê±´</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function updateWordCloud(data) {
            console.log('ğŸ” Updating word cloud with data:', data.length, 'messages');
            
            // Extract keywords from content and classification categories
            const keywordFrequency = {};
            
            data.forEach(item => {
                // Add classification category as a keyword
                if (item.classification) {
                    const categoryNames = {
                        'billing': 'ê´€ë¦¬ë¹„',
                        'maintenance': 'ìˆ˜ë¦¬',
                        'parking': 'ì£¼ì°¨',
                        'noise': 'ì†ŒìŒ',
                        'inquiry': 'ë¬¸ì˜',
                        'complaint': 'ë¯¼ì›',
                        'facility': 'ì‹œì„¤',
                        'security': 'ë³´ì•ˆ'
                    };
                    const categoryKeyword = categoryNames[item.classification] || item.classification;
                    keywordFrequency[categoryKeyword] = (keywordFrequency[categoryKeyword] || 0) + 3; // Weight categories higher
                }
                
                // Extract meaningful Korean keywords from content
                const content = item.content || item.maskedContent; // Use original content for better keyword extraction
                const keywords = extractKoreanKeywords(content);
                keywords.forEach(keyword => {
                    keywordFrequency[keyword] = (keywordFrequency[keyword] || 0) + 1;
                });
            });
            
            console.log('ğŸ“Š Keyword frequency:', Object.keys(keywordFrequency).length, 'unique keywords');
            console.log('ğŸ” Top keywords:', Object.entries(keywordFrequency).sort((a, b) => b[1] - a[1]).slice(0, 10));
            
            // Convert to word cloud format
            const wordCloudData = Object.entries(keywordFrequency)
                .filter(([keyword, count]) => count >= 1 && keyword.length >= 2) // Show meaningful keywords
                .sort((a, b) => b[1] - a[1]) // Sort by frequency
                .slice(0, 25) // Top 25 keywords
                .map(([keyword, count]) => [keyword, Math.max(count * 12, 10)]); // Scale for better visualization

            console.log('â˜ï¸ Word cloud data:', wordCloudData.length, 'keywords:', wordCloudData.slice(0, 10));

            // Clear previous word cloud
            const canvas = document.getElementById('wordCloud');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (wordCloudData.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ë¶„ì„í•  ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', canvas.width / 2, canvas.height / 2);
                console.log('âš ï¸ No word cloud data to display');
                return;
            }

            // Check if WordCloud is available
            if (typeof WordCloud === 'undefined') {
                console.error('âŒ WordCloud library not loaded');
                ctx.fillStyle = '#EF4444';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ì›Œë“œí´ë¼ìš°ë“œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨', canvas.width / 2, canvas.height / 2);
                return;
            }

            console.log('âœ… Generating word cloud...');
            
            // Generate word cloud
            try {
                WordCloud(canvas, {
                    list: wordCloudData,
                    gridSize: Math.round(16 * canvas.width / 1024),
                    weightFactor: function (size) {
                        return Math.pow(size, 0.8) * canvas.width / 1024;
                    },
                    fontFamily: 'Noto Sans KR, Arial, sans-serif',
                    color: function () {
                        const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    rotateRatio: 0.3,
                    backgroundColor: '#FFFFFF',
                    minSize: 12,
                    drawOutOfBound: false
                });
                console.log('âœ… Word cloud generated successfully');
            } catch (error) {
                console.error('âŒ Error generating word cloud:', error);
                console.log('ğŸ”„ Falling back to simple text display');
                drawSimpleWordCloud(canvas, wordCloudData);
            }

            // Update stats
            const statsDiv = document.getElementById('wordCloudStats');
            const totalWords = Object.keys(wordFrequency).length;
            const totalMentions = Object.values(wordFrequency).reduce((sum, count) => sum + count, 0);
            const topWord = wordCloudData[0];
            
            statsDiv.innerHTML = `
                <div class="flex justify-center space-x-6 text-sm">
                    <span>ì´ í‚¤ì›Œë“œ: <strong>${totalWords}ê°œ</strong></span>
                    <span>ì´ ì–¸ê¸‰: <strong>${totalMentions}íšŒ</strong></span>
                    ${topWord ? `<span>ìµœë‹¤ ì–¸ê¸‰: <strong>"${topWord[0]}" (${Math.round(topWord[1]/10)}íšŒ)</strong></span>` : ''}
                </div>
            `;

            // Update top keywords section
            updateTopKeywords(wordFrequency);
        }

        function extractKoreanKeywords(text) {
            // Extract meaningful Korean apartment management keywords
            const apartmentKeywords = [
                // Facilities
                'ì—˜ë¦¬ë² ì´í„°', 'ìŠ¹ê°•ê¸°', 'ì£¼ì°¨ì¥', 'ì£¼ì°¨', 'íƒë°°ë³´ê´€í•¨', 'íƒë°°í•¨', 'ìš°í¸í•¨', 
                'ê´€ë¦¬ì‚¬ë¬´ì†Œ', 'ê²½ë¹„ì‹¤', 'ë¡œë¹„', 'ë³µë„', 'ê³„ë‹¨', 'ì˜¥ìƒ', 'ì§€í•˜ì‹¤', 'ì°½ê³ ',
                
                // Utilities & Systems  
                'ë‚œë°©', 'ëƒ‰ë°©', 'ì—ì–´ì»¨', 'ë³´ì¼ëŸ¬', 'ì˜¨ìˆ˜', 'ëƒ‰ìˆ˜', 'ìˆ˜ë„', 'ì „ê¸°', 'ê°€ìŠ¤',
                'ì¸í„°ë„·', 'ì¼€ì´ë¸”', 'ì „í™”', 'ì¸í„°í°', 'ë°©ì†¡', 'ì¡°ëª…', 'í™˜ê¸°', 'ì •ì „', 'ë³µêµ¬',
                
                // Maintenance Issues
                'ê³ ì¥', 'ìˆ˜ë¦¬', 'ì ê²€', 'êµì²´', 'ì²­ì†Œ', 'ì •ë¹„', 'ë³´ìˆ˜', 'ëˆ„ìˆ˜', 'ë§‰í˜',
                'ì†ŒìŒ', 'ì§„ë™', 'ëƒ„ìƒˆ', 'ê³°íŒ¡ì´', 'ìŠµê¸°', 'ê· ì—´', 'íŒŒì†', 'ë°©ìŒ',
                
                // Services & Fees
                'ê´€ë¦¬ë¹„', 'ê³µê³¼ê¸ˆ', 'ìˆ˜ë„ìš”ê¸ˆ', 'ì „ê¸°ìš”ê¸ˆ', 'ê°€ìŠ¤ìš”ê¸ˆ', 'ì£¼ì°¨ë¹„', 'ì˜ìˆ˜ì¦', 'ì¬ë°œê¸‰',
                'ì²­ì†Œë¹„', 'ë³´ì•ˆë¹„', 'ìˆ˜ì„ ì¶©ë‹¹ê¸ˆ', 'ì¥ê¸°ìˆ˜ì„ ì¶©ë‹¹ê¸ˆ', 'í• ì¸', 'ìš”ê¸ˆ', 'ì›”ì •ì•¡',
                
                // Security & Safety
                'ë³´ì•ˆ', 'ë°©ë²”', 'CCTV', 'ì¶œì…', 'ì¶œì…ë¬¸', 'ë¹„ë°€ë²ˆí˜¸', 'ì¹´ë“œí‚¤', 
                'í™”ì¬', 'ì†Œë°©', 'ë¹„ìƒêµ¬', 'ì•ˆì „', 'ì‚¬ê³ ', 'ë„ë‚œ',
                
                // Community & Rules
                'ë¯¼ì›', 'ë¶„ë¦¬ìˆ˜ê±°', 'ì“°ë ˆê¸°', 'ì¬í™œìš©', 'ë°˜ë ¤ë™ë¬¼', 'ì• ì™„ë™ë¬¼',
                'í¡ì—°', 'ê¸ˆì—°', 'ì£¼ë¯¼', 'ì…ì£¼ë¯¼', 'ì´ì‚¬', 'ì…ì£¼', 'í‡´ê±°', 'ì»¤ë®¤ë‹ˆí‹°', 'í™œë™', 'ì°¸ì—¬',
                'ë¶ˆë²•ì£¼ì°¨', 'ê¸ˆì—°êµ¬ì—­', 'ì˜¨ë„ì¡°ì ˆ',
                
                // Common Issues
                'ë¬¸ì˜', 'ì‹ ê³ ', 'ìš”ì²­', 'ê±´ì˜', 'ë¶ˆë§Œ', 'ê°œì„ ', 'í•´ê²°', 'ì²˜ë¦¬',
                'í™•ì¸', 'ì ê²€', 'ì¡°ì¹˜', 'ëŒ€ì‘', 'ì•ˆë‚´', 'ê³µì§€', 'ì¶”ì²œ', 'ì—…ì²´'
            ];
            
            const foundKeywords = [];
            
            // Find exact matches for apartment keywords
            apartmentKeywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    foundKeywords.push(keyword);
                }
            });
            
            // Extract compound Korean words (2-4 characters)
            const koreanWords = text.match(/[ê°€-í£]{2,4}/g) || [];
            const stopwords = new Set([
                'ì´ê²ƒ', 'ê·¸ê²ƒ', 'ì €ê²ƒ', 'ì—¬ê¸°', 'ê±°ê¸°', 'ì €ê¸°', 'ë•Œë¬¸', 'ìœ„í•´', 'í†µí•´', 'ëŒ€í•´', 'ê´€í•´',
                'ìˆë‚˜ìš”', 'ìŠµë‹ˆë‹¤', 'ì…ë‹ˆë‹¤', 'í•©ë‹ˆë‹¤', 'ë©ë‹ˆë‹¤', 'í•´ì£¼ì„¸ìš”', 'ë¶€íƒë“œë ¤ìš”', 'ê°ì‚¬í•©ë‹ˆë‹¤',
                'ì•ˆë…•í•˜ì„¸ìš”', 'ì£„ì†¡í•©ë‹ˆë‹¤', 'ì‹¤ë¡€í•©ë‹ˆë‹¤', 'í™•ì¸í•´ì£¼ì„¸ìš”', 'ì•Œë ¤ì£¼ì„¸ìš”', 'ë„ì™€ì£¼ì„¸ìš”',
                'ì–¸ì œ', 'ì–´ë””', 'ì–¼ë§ˆ', 'ì–´ë–»ê²Œ', 'ë¬´ì—‡', 'ëˆ„êµ¬', 'ì™œ', 'ì–´ëŠ', 'ëª‡ê°œ', 'ëª‡ëª…'
            ]);
            
            koreanWords.forEach(word => {
                if (word.length >= 2 && 
                    !foundKeywords.includes(word) && 
                    !stopwords.has(word) &&
                    !/^[0-9]+$/.test(word)) { // Exclude pure numbers
                    foundKeywords.push(word);
                }
            });
            
            return [...new Set(foundKeywords)]; // Remove duplicates
        }

        function analyzeWordFrequency(text) {
            console.log('ğŸ” Analyzing text of length:', text.length);
            
            // Korean text processing
            const frequency = {};
            
            // Remove special characters and normalize
            const cleanText = text
                .replace(/[^\w\sê°€-í£]/g, ' ')
                .replace(/\s+/g, ' ')
                .toLowerCase()
                .trim();

            console.log('ğŸ§¹ Clean text length:', cleanText.length);

            // Split into words
            const words = cleanText.split(' ');
            console.log('ğŸ“ Total words:', words.length);
            
            // Korean stopwords and common words to filter out
            const stopwords = new Set([
                'ì´', 'ê·¸', 'ì €', 'ê²ƒ', 'ìˆ˜', 'ìˆ', 'ì—†', 'í•˜', 'ë˜', 'ëœ', 'ë ', 'ëŠ”', 'ì€', 'ì´', 'ê°€', 'ì„', 'ë¥¼', 
                'ì—', 'ì—ì„œ', 'ë¡œ', 'ìœ¼ë¡œ', 'ì™€', 'ê³¼', 'ë„', 'ë§Œ', 'ê¹Œì§€', 'ë¶€í„°', 'ë³´ë‹¤', 'ì²˜ëŸ¼', 'ê°™ì´', 'í•¨ê»˜',
                'ê·¸ë¦¬ê³ ', 'ê·¸ëŸ°ë°', 'í•˜ì§€ë§Œ', 'ê·¸ëŸ¬ë‚˜', 'ë˜í•œ', 'ë˜', 'ë°', 'ë“±', 'ì¦‰', 'ì˜ˆë¥¼ë“¤ì–´',
                'ìˆìŠµë‹ˆë‹¤', 'ìŠµë‹ˆë‹¤', 'ì…ë‹ˆë‹¤', 'í•©ë‹ˆë‹¤', 'ë©ë‹ˆë‹¤', 'ë‹ˆë‹¤', 'ì„¸ìš”', 'ìš”', 'ë„¤ìš”', 'ì–´ìš”',
                'ë•Œë¬¸', 'ìœ„í•´', 'í†µí•´', 'ëŒ€í•´', 'ê´€í•´', 'ë”°ë¼', 'ì˜í•´', 'ì—ê²Œ', 'í•œí…Œ', 'ê»˜', 'ì—ì„œ',
                'ë…„', 'ì›”', 'ì¼', 'ì‹œ', 'ë¶„', 'ì´ˆ', 'ì˜¤ì „', 'ì˜¤í›„', 'ì•„ì¹¨', 'ì ì‹¬', 'ì €ë…', 'ë°¤',
                'ì¸µ', 'í˜¸', 'ë™', 'ë²ˆ', 'ê°œ', 'ëª…', 'ë¶„', 'ì‹œê°„', 'ë‚ ', 'ì£¼', 'ë‹¬',
                'ì•ˆë…•í•˜ì„¸ìš”', 'ê°ì‚¬í•©ë‹ˆë‹¤', 'ì£„ì†¡í•©ë‹ˆë‹¤', 'ì‹¤ë¡€í•©ë‹ˆë‹¤', 'ë¶€íƒë“œë¦½ë‹ˆë‹¤', 'í™•ì¸', 'ë¬¸ì˜', 'ì‹ ê³ '
            ]);

            // Count word frequency
            words.forEach(word => {
                if (word.length >= 2 && !stopwords.has(word) && !/^\d+$/.test(word)) {
                    frequency[word] = (frequency[word] || 0) + 1;
                }
            });

            // Filter out very rare words (appear only once) unless they're important keywords
            const importantKeywords = new Set([
                'ì—˜ë¦¬ë² ì´í„°', 'ì£¼ì°¨', 'ì†ŒìŒ', 'ê´€ë¦¬ë¹„', 'ë³´ì•ˆ', 'ì¶œì…', 'í™”ì¬', 'ê°€ìŠ¤', 'ëˆ„ìˆ˜', 'ê³ ì¥', 'ìˆ˜ë¦¬',
                'ì²­ì†Œ', 'ì“°ë ˆê¸°', 'ë¶„ë¦¬ìˆ˜ê±°', 'íƒë°°', 'ë°©ë¬¸', 'ê³µì‚¬', 'ì‹œì„¤', 'ì „ê¸°', 'ìˆ˜ë„', 'ë‚œë°©',
                'ì—ì–´ì»¨', 'ì¸í„°ë„·', 'ì „í™”', 'ë„ì–´ë½', 'cctv', 'ë°©ë²”', 'ìˆœì°°', 'ë¯¼ì›', 'ë¶ˆë§Œ', 'ê°œì„ '
            ]);

            const filteredFrequency = {};
            Object.entries(frequency).forEach(([word, count]) => {
                if (count > 1 || importantKeywords.has(word)) {
                    filteredFrequency[word] = count;
                }
            });

            return filteredFrequency;
        }

        function drawSimpleWordCloud(canvas, wordCloudData) {
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background
            ctx.fillStyle = '#F9FAFB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            let currentY = 50;
            let currentX = 50;
            const maxWidth = canvas.width - 100;
            
            wordCloudData.forEach(([word, size], index) => {
                const fontSize = Math.max(12, Math.min(48, size / 10));
                ctx.font = `${fontSize}px Noto Sans KR, Arial, sans-serif`;
                ctx.fillStyle = colors[index % colors.length];
                
                const textWidth = ctx.measureText(word).width;
                
                // Check if word fits on current line
                if (currentX + textWidth > maxWidth) {
                    currentX = 50;
                    currentY += fontSize + 10;
                }
                
                // Don't draw if we're out of canvas bounds
                if (currentY > canvas.height - 50) return;
                
                ctx.fillText(word, currentX, currentY);
                currentX += textWidth + 20;
            });
            
            // Add title
            ctx.font = '16px Arial';
            ctx.fillStyle = '#6B7280';
            ctx.textAlign = 'center';
            ctx.fillText('ì£¼ìš” í‚¤ì›Œë“œ (ê°„ë‹¨ í‘œì‹œ)', centerX, 25);
            ctx.textAlign = 'left';
        }

        function updateTopKeywords(wordFrequency) {
            const topKeywordsDiv = document.getElementById('topKeywords');
            
            const sortedKeywords = Object.entries(wordFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (sortedKeywords.length === 0) {
                topKeywordsDiv.innerHTML = '<div class="text-center text-gray-500 col-span-full">ë¶„ì„í•  í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const maxCount = sortedKeywords[0][1];
            
            topKeywordsDiv.innerHTML = sortedKeywords.map(([keyword, count], index) => {
                const percentage = (count / maxCount) * 100;
                
                return `
                    <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">${keyword}</div>
                                <div class="text-sm text-gray-500">${count}íšŒ ì–¸ê¸‰</div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 w-20">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Update category keywords
            updateCategoryKeywords(wordFrequency);
            
            // Generate AI insights
            generateAIInsights(wordFrequency, data);
        }

        function updateCategoryKeywords(wordFrequency) {
            const categoryKeywordsDiv = document.getElementById('categoryKeywords');
            
            // Define keyword categories
            const categories = {
                'ì‹œì„¤ê´€ë¦¬': ['ì—˜ë¦¬ë² ì´í„°', 'ê³ ì¥', 'ìˆ˜ë¦¬', 'ì „ê¸°', 'ìˆ˜ë„', 'ë‚œë°©', 'ì—ì–´ì»¨', 'ì‹œì„¤', 'ê³µì‚¬', 'ì²­ì†Œ'],
                'ì†ŒìŒ': ['ì†ŒìŒ', 'ì‹œë„', 'ì¸µê°„ì†ŒìŒ', 'ìœ—ì§‘', 'ì•„ë˜ì§‘', 'ë°¤', 'ìƒˆë²½', 'ìŒì•…', 'ë°œì†Œë¦¬'],
                'ì£¼ì°¨': ['ì£¼ì°¨', 'ì°¨ëŸ‰', 'ì£¼ì°¨ì¥', 'ì£¼ì°¨ìœ„ë°˜', 'ë¶ˆë²•ì£¼ì°¨', 'ì£¼ì°¨ê³µê°„', 'ìë™ì°¨', 'ì˜¤í† ë°”ì´'],
                'ê´€ë¦¬ë¹„': ['ê´€ë¦¬ë¹„', 'ìš”ê¸ˆ', 'ì²­êµ¬ì„œ', 'ë‚©ë¶€', 'ì—°ì²´', 'í• ì¸', 'ìš”ê¸ˆí‘œ', 'ê³„ì‚°ì„œ'],
                'ë³´ì•ˆ': ['ë³´ì•ˆ', 'ì¶œì…', 'ë„ì–´ë½', 'í‚¤', 'ë¶„ì‹¤', 'cctv', 'ë°©ë²”', 'ìˆœì°°', 'ì•ˆì „'],
                'ìƒí™œí¸ì˜': ['íƒë°°', 'ë°©ë¬¸', 'ì“°ë ˆê¸°', 'ë¶„ë¦¬ìˆ˜ê±°', 'ì¸í„°ë„·', 'ì „í™”', 'ë°©ì†¡', 'ê³µì§€']
            };

            const categoryStats = {};
            
            // Calculate category statistics
            Object.entries(categories).forEach(([category, keywords]) => {
                let totalCount = 0;
                const foundKeywords = [];
                
                keywords.forEach(keyword => {
                    if (wordFrequency[keyword]) {
                        totalCount += wordFrequency[keyword];
                        foundKeywords.push({ keyword, count: wordFrequency[keyword] });
                    }
                });
                
                if (totalCount > 0) {
                    categoryStats[category] = {
                        totalCount,
                        keywords: foundKeywords.sort((a, b) => b.count - a.count).slice(0, 3)
                    };
                }
            });

            if (Object.keys(categoryStats).length === 0) {
                categoryKeywordsDiv.innerHTML = '<div class="text-center text-gray-500">ì¹´í…Œê³ ë¦¬ë³„ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const maxCategoryCount = Math.max(...Object.values(categoryStats).map(cat => cat.totalCount));

            categoryKeywordsDiv.innerHTML = Object.entries(categoryStats)
                .sort((a, b) => b[1].totalCount - a[1].totalCount)
                .map(([category, stats]) => {
                    const percentage = (stats.totalCount / maxCategoryCount) * 100;
                    const categoryColors = {
                        'ì‹œì„¤ê´€ë¦¬': 'bg-blue-500',
                        'ì†ŒìŒ': 'bg-red-500',
                        'ì£¼ì°¨': 'bg-yellow-500',
                        'ê´€ë¦¬ë¹„': 'bg-green-500',
                        'ë³´ì•ˆ': 'bg-purple-500',
                        'ìƒí™œí¸ì˜': 'bg-indigo-500'
                    };
                    const color = categoryColors[category] || 'bg-gray-500';
                    
                    return `
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium text-gray-900">${category}</h4>
                                <span class="text-sm text-gray-500">${stats.totalCount}íšŒ</span>
                            </div>
                            <div class="mb-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${color} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${stats.keywords.map(({ keyword, count }) => `
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        ${keyword} (${count})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function generateAIInsights(wordFrequency, data) {
            const insightsDiv = document.getElementById('aiInsights');
            const insights = [];

            // Analyze top issues
            const topKeywords = Object.entries(wordFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topKeywords.length > 0) {
                const topIssue = topKeywords[0];
                insights.push({
                    icon: 'ğŸ”',
                    title: 'ì£¼ìš” ì´ìŠˆ ë¶„ì„',
                    content: `"${topIssue[0]}"ê°€ ${topIssue[1]}íšŒë¡œ ê°€ì¥ ë§ì´ ì–¸ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ë¶„ì•¼ì— ëŒ€í•œ ì§‘ì¤‘ì ì¸ ê´€ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`
                });
            }

            // Analyze urgency patterns
            const urgentCount = data.filter(item => item.priority === 'urgent').length;
            const highCount = data.filter(item => item.priority === 'high').length;
            const totalCount = data.length;

            if (totalCount > 0) {
                const urgencyRate = ((urgentCount + highCount) / totalCount * 100).toFixed(1);
                if (urgencyRate > 50) {
                    insights.push({
                        icon: 'âš ï¸',
                        title: 'ê¸´ê¸‰ë„ ë¶„ì„',
                        content: `ì „ì²´ ìš”ì²­ì˜ ${urgencyRate}%ê°€ ë†’ì€ ìš°ì„ ìˆœìœ„ì…ë‹ˆë‹¤. ì‹ ì†í•œ ëŒ€ì‘ ì²´ê³„ ê°•í™”ê°€ í•„ìš”í•©ë‹ˆë‹¤.`
                    });
                } else {
                    insights.push({
                        icon: 'âœ…',
                        title: 'ê¸´ê¸‰ë„ ë¶„ì„',
                        content: `ì „ì²´ ìš”ì²­ì˜ ${urgencyRate}%ê°€ ë†’ì€ ìš°ì„ ìˆœìœ„ë¡œ ì ì • ìˆ˜ì¤€ì…ë‹ˆë‹¤.`
                    });
                }
            }

            // Analyze channel patterns
            const channelCounts = {};
            data.forEach(item => {
                channelCounts[item.channel] = (channelCounts[item.channel] || 0) + 1;
            });

            const topChannel = Object.entries(channelCounts)
                .sort((a, b) => b[1] - a[1])[0];

            if (topChannel) {
                const channelNames = { sms: 'SMS', email: 'ì´ë©”ì¼', web: 'ì›¹í¼', call: 'í†µí™”' };
                insights.push({
                    icon: 'ğŸ“Š',
                    title: 'ì±„ë„ ë¶„ì„',
                    content: `${channelNames[topChannel[0]] || topChannel[0]}ë¥¼ í†µí•œ ì ‘ìˆ˜ê°€ ${topChannel[1]}ê±´ìœ¼ë¡œ ê°€ì¥ ë§ìŠµë‹ˆë‹¤. ì´ ì±„ë„ì˜ ì‚¬ìš©ì„± ê°œì„ ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`
                });
            }

            // Analyze processing efficiency
            const processedCount = data.filter(item => item.status === 'processed').length;
            const processingRate = totalCount > 0 ? (processedCount / totalCount * 100).toFixed(1) : 0;

            if (processingRate < 30) {
                insights.push({
                    icon: 'ğŸ“ˆ',
                    title: 'ì²˜ë¦¬ íš¨ìœ¨ì„±',
                    content: `ì²˜ë¦¬ ì™„ë£Œìœ¨ì´ ${processingRate}%ë¡œ ë‚®ìŠµë‹ˆë‹¤. ì—…ë¬´ í”„ë¡œì„¸ìŠ¤ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`
                });
            } else if (processingRate > 80) {
                insights.push({
                    icon: 'ğŸ¯',
                    title: 'ì²˜ë¦¬ íš¨ìœ¨ì„±',
                    content: `ì²˜ë¦¬ ì™„ë£Œìœ¨ì´ ${processingRate}%ë¡œ ìš°ìˆ˜í•©ë‹ˆë‹¤. í˜„ì¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ìœ ì§€í•˜ì„¸ìš”.`
                });
            }

            // Analyze keyword diversity
            const keywordCount = Object.keys(wordFrequency).length;
            if (keywordCount > 20) {
                insights.push({
                    icon: 'ğŸ”„',
                    title: 'ì´ìŠˆ ë‹¤ì–‘ì„±',
                    content: `${keywordCount}ê°œì˜ ë‹¤ì–‘í•œ í‚¤ì›Œë“œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì–‘í•œ ì´ìŠˆì— ëŒ€í•œ ì¢…í•©ì ì¸ ëŒ€ì‘ ë°©ì•ˆì´ í•„ìš”í•©ë‹ˆë‹¤.`
                });
            }

            if (insights.length === 0) {
                insightsDiv.innerHTML = '<div class="text-center text-blue-600">ë¶„ì„í•  ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>';
                return;
            }

            insightsDiv.innerHTML = insights.map(insight => `
                <div class="flex items-start space-x-3 p-4 bg-white rounded-lg border border-blue-100">
                    <div class="flex-shrink-0 text-2xl">${insight.icon}</div>
                    <div class="flex-1">
                        <h4 class="font-medium text-blue-900">${insight.title}</h4>
                        <p class="text-sm text-blue-700 mt-1">${insight.content}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateChannelChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js not available for channel chart');
                return;
            }

            const channelCounts = {};
            data.forEach(item => {
                channelCounts[item.channel] = (channelCounts[item.channel] || 0) + 1;
            });

            const ctx = document.getElementById('channelChart').getContext('2d');
            
            if (charts.channel) {
                charts.channel.destroy();
            }
            
            charts.channel = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(channelCounts).map(channel => {
                        const labels = { sms: 'SMS', email: 'ì´ë©”ì¼', web: 'ì›¹í¼', call: 'í†µí™”' };
                        return labels[channel] || channel;
                    }),
                    datasets: [{
                        data: Object.values(channelCounts),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateStatusChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js not available for status chart');
                return;
            }

            const statusCounts = {};
            data.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.status) {
                charts.status.destroy();
            }
            
            charts.status = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts).map(status => {
                        const labels = { pending: 'ëŒ€ê¸°ì¤‘', classified: 'ë¶„ë¥˜ì™„ë£Œ', assigned: 'í• ë‹¹ë¨', processed: 'ì²˜ë¦¬ì™„ë£Œ' };
                        return labels[status] || status;
                    }),
                    datasets: [{
                        label: 'ê±´ìˆ˜',
                        data: Object.values(statusCounts),
                        backgroundColor: '#6366F1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updatePriorityChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js not available for priority chart');
                return;
            }

            const priorityCounts = {};
            data.forEach(item => {
                priorityCounts[item.priority] = (priorityCounts[item.priority] || 0) + 1;
            });

            const ctx = document.getElementById('priorityChart').getContext('2d');
            
            if (charts.priority) {
                charts.priority.destroy();
            }
            
            charts.priority = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(priorityCounts).map(priority => {
                        const labels = { urgent: 'ê¸´ê¸‰', high: 'ë†’ìŒ', medium: 'ë³´í†µ', low: 'ë‚®ìŒ' };
                        return labels[priority] || priority;
                    }),
                    datasets: [{
                        data: Object.values(priorityCounts),
                        backgroundColor: ['#DC2626', '#F59E0B', '#10B981', '#6B7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateTrendChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js not available for trend chart');
                return;
            }

            // Group data by date
            const dailyCounts = {};
            data.forEach(item => {
                const date = new Date(item.createdAt).toISOString().split('T')[0];
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });

            const sortedDates = Object.keys(dailyCounts).sort();
            const counts = sortedDates.map(date => dailyCounts[date]);

            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (charts.trend) {
                charts.trend.destroy();
            }
            
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('ko-KR')),
                    datasets: [{
                        label: 'ì¼ë³„ ì ‘ìˆ˜',
                        data: counts,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateDataTable(data) {
            const tableBody = document.getElementById('dataTable');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                return;
            }

            const channelEmojis = { sms: 'ğŸ“±', email: 'ğŸ“§', web: 'ğŸŒ', call: 'ğŸ“' };
            const priorityColors = {
                urgent: 'bg-red-100 text-red-800',
                high: 'bg-orange-100 text-orange-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-green-100 text-green-800'
            };
            const statusColors = {
                pending: 'bg-gray-100 text-gray-800',
                classified: 'bg-blue-100 text-blue-800',
                assigned: 'bg-purple-100 text-purple-800',
                processed: 'bg-green-100 text-green-800'
            };
            const statusLabels = {
                pending: 'ëŒ€ê¸°ì¤‘',
                classified: 'ë¶„ë¥˜ì™„ë£Œ',
                assigned: 'í• ë‹¹ë¨',
                processed: 'ì²˜ë¦¬ì™„ë£Œ'
            };

            tableBody.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(item.createdAt).toLocaleString('ko-KR')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${channelEmojis[item.channel] || 'ğŸ“'} ${item.channel.toUpperCase()}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
                        ${item.maskedContent || item.content}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColors[item.priority] || 'bg-gray-100 text-gray-800'}">
                            ${item.priority}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[item.status] || 'bg-gray-100 text-gray-800'}">
                            ${statusLabels[item.status] || item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.classification || '-'}
                    </td>
                </tr>
            `).join('');
        }

        // Event listeners
        document.getElementById('loadData').addEventListener('click', () => {
            console.log('ğŸ”„ Manual data load requested');
            loadReportData();
        });
        
        document.getElementById('applyFilters').addEventListener('click', loadReportData);
        
        document.getElementById('resetFilters').addEventListener('click', () => {
            document.getElementById('channelFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            loadReportData();
        });

        document.getElementById('exportCSV').addEventListener('click', () => {
            const filters = getFilterValues();
            const filteredData = applyFilters(currentData, filters);
            exportToCSV(filteredData);
        });

        document.getElementById('testWordCloud').addEventListener('click', () => {
            console.log('ğŸ§ª Testing word cloud with current data:', currentData.length, 'messages');
            if (currentData.length > 0) {
                updateWordCloud(currentData);
            } else {
                console.log('ğŸ“ No data loaded, using sample Korean apartment terms for testing');
                // Use sample Korean apartment management terms for testing
                const sampleData = [
                    { content: 'ì—˜ë¦¬ë² ì´í„° ê³ ì¥ ì‹ ê³ í•©ë‹ˆë‹¤', classification: { keywords: ['ì—˜ë¦¬ë² ì´í„°', 'ê³ ì¥', 'ì‹ ê³ '] } },
                    { content: 'ì£¼ì°¨ì¥ ë¶ˆë²•ì£¼ì°¨ ë¬¸ì œ', classification: { keywords: ['ì£¼ì°¨ì¥', 'ë¶ˆë²•ì£¼ì°¨', 'ë¬¸ì œ'] } },
                    { content: 'ì†ŒìŒ ë¯¼ì› ì ‘ìˆ˜', classification: { keywords: ['ì†ŒìŒ', 'ë¯¼ì›', 'ì ‘ìˆ˜'] } },
                    { content: 'ëˆ„ìˆ˜ ì‹ ê³  ë“œë¦½ë‹ˆë‹¤', classification: { keywords: ['ëˆ„ìˆ˜', 'ì‹ ê³ ', 'ìˆ˜ë¦¬'] } },
                    { content: 'ê´€ë¦¬ë¹„ ë¬¸ì˜ì‚¬í•­', classification: { keywords: ['ê´€ë¦¬ë¹„', 'ë¬¸ì˜', 'ìš”ê¸ˆ'] } },
                    { content: 'íƒë°°ë³´ê´€í•¨ ê³ ì¥', classification: { keywords: ['íƒë°°ë³´ê´€í•¨', 'ê³ ì¥', 'ìˆ˜ë¦¬'] } },
                    { content: 'ë‚œë°© ì˜¨ë„ ì¡°ì ˆ ìš”ì²­', classification: { keywords: ['ë‚œë°©', 'ì˜¨ë„', 'ì¡°ì ˆ'] } },
                    { content: 'ì²­ì†Œ ìƒíƒœ ë¶ˆë§Œ', classification: { keywords: ['ì²­ì†Œ', 'ìƒíƒœ', 'ë¶ˆë§Œ'] } },
                    { content: 'ë³´ì•ˆ ë¬¸ì œ ì‹ ê³ ', classification: { keywords: ['ë³´ì•ˆ', 'ë¬¸ì œ', 'ì‹ ê³ '] } },
                    { content: 'ì‹œì„¤ ê°œì„  ê±´ì˜', classification: { keywords: ['ì‹œì„¤', 'ê°œì„ ', 'ê±´ì˜'] } }
                ];
                updateWordCloud(sampleData);
                alert('ìƒ˜í”Œ ë°ì´í„°ë¡œ ì›Œë“œí´ë¼ìš°ë“œë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ë°ì´í„°ë¥¼ ë³´ë ¤ë©´ ë¨¼ì € "ğŸ“Š ë°ì´í„° ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
            }
        });

        document.getElementById('debugLibraries').addEventListener('click', () => {
            const chartAvailable = typeof Chart !== 'undefined';
            const wordCloudAvailable = typeof WordCloud !== 'undefined';
            
            alert(`ë¼ì´ë¸ŒëŸ¬ë¦¬ ìƒíƒœ:
Chart.js: ${chartAvailable ? 'âœ… ë¡œë“œë¨' : 'âŒ ë¡œë“œ ì‹¤íŒ¨'}
WordCloud: ${wordCloudAvailable ? 'âœ… ë¡œë“œë¨' : 'âŒ ë¡œë“œ ì‹¤íŒ¨'}
ë°ì´í„°: ${currentData.length}ê°œ ë©”ì‹œì§€`);
            
            console.log('ğŸ” Library debug info:', {
                Chart: typeof Chart,
                WordCloud: typeof WordCloud,
                dataCount: currentData.length
            });
        });

        function exportToCSV(data) {
            const headers = ['ì ‘ìˆ˜ì¼ì‹œ', 'ì±„ë„', 'ë‚´ìš©', 'ìš°ì„ ìˆœìœ„', 'ìƒíƒœ', 'ë¶„ë¥˜'];
            const csvContent = [
                headers.join(','),
                ...data.map(item => [
                    new Date(item.createdAt).toLocaleString('ko-KR'),
                    item.channel,
                    `"${(item.maskedContent || item.content).replace(/"/g, '""')}"`,
                    item.priority,
                    item.status,
                    item.classification || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ì ‘ìˆ˜í˜„í™©_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>