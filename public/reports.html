<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Secretary - 리포트</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.2/wordcloud2.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-white text-xl font-bold">AI Secretary</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">홈</a>
                    <a href="/dashboard" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">대시보드</a>
                    <a href="/test" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">테스트</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">운영 리포트</h1>
            <p class="mt-2 text-gray-600">접수 현황 분석 및 통계 리포트</p>
        </div>

        <!-- Filters -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">필터 설정</h2>
            </div>
            <div class="px-6 py-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Date Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">기간 설정</label>
                        <div class="space-y-2">
                            <input type="date" id="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <input type="date" id="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                        </div>
                    </div>

                    <!-- Channel Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">접수 채널</label>
                        <select id="channelFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">전체 채널</option>
                            <option value="sms">📱 SMS</option>
                            <option value="email">📧 이메일</option>
                            <option value="web">🌐 웹폼</option>
                            <option value="call">📞 통화</option>
                        </select>
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">처리 상태</label>
                        <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">전체 상태</option>
                            <option value="pending">대기중</option>
                            <option value="classified">분류완료</option>
                            <option value="assigned">할당됨</option>
                            <option value="processed">처리완료</option>
                        </select>
                    </div>

                    <!-- Priority Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">우선순위</label>
                        <select id="priorityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            <option value="">전체 우선순위</option>
                            <option value="urgent">긴급</option>
                            <option value="high">높음</option>
                            <option value="medium">보통</option>
                            <option value="low">낮음</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex flex-wrap gap-2 items-center">
                    <button id="loadData" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium">
                        🔄 새로고침
                    </button>
                    <span id="dataStatus" class="text-sm text-gray-500 hidden">
                        ⏳ 데이터 로딩 중...
                    </span>
                    <button id="applyFilters" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        필터 적용
                    </button>
                    <button id="enableLLMAnalysis" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        🤖 LLM 분석 (느림)
                    </button>
                    <button id="resetFilters" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                        초기화
                    </button>
                    <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        CSV 내보내기
                    </button>
                    <button id="testWordCloud" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        🔤 워드클라우드 테스트
                    </button>
                    <button id="debugLibraries" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                        라이브러리 상태 확인
                    </button>
                    <button id="testKeywords" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700">
                        🔍 키워드 테스트
                    </button>
                    <button id="testSections" class="bg-pink-600 text-white px-4 py-2 rounded-md hover:bg-pink-700">
                        🧪 섹션 테스트
                    </button>
                    <button id="simpleTest" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        ✅ 간단 테스트
                    </button>
                    <button id="debugFilters" class="bg-yellow-600 text-white px-4 py-2 rounded-md hover:bg-yellow-700">
                        🔍 필터 디버그
                    </button>
                    <button id="debugFlow" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                        🚨 전체 디버그
                    </button>
                    <button id="fixTrendChart" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                        🔧 차트 강제 수정
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">📨</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">총 접수</dt>
                                <dd class="text-lg font-medium text-gray-900" id="totalMessages">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">✅</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">처리완료</dt>
                                <dd class="text-lg font-medium text-gray-900" id="processedMessages">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">⏳</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">평균 처리시간</dt>
                                <dd class="text-lg font-medium text-gray-900" id="avgProcessingTime">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                                <span class="text-white text-sm">🎯</span>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">SLA 준수율</dt>
                                <dd class="text-lg font-medium text-gray-900" id="slaCompliance">-</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Cloud -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">주요 키워드 분석</h3>
                <p class="text-sm text-gray-500 mt-1">접수된 요청에서 가장 자주 언급되는 키워드들</p>
            </div>
            <div class="p-6">
                <div class="flex justify-center">
                    <canvas id="wordCloud" width="800" height="400" style="max-width: 100%; height: 400px;"></canvas>
                </div>
                <div class="mt-4 text-center">
                    <div id="wordCloudStats" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>

        <!-- AI Insights -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-blue-200">
                <h3 class="text-lg font-medium text-blue-900 flex items-center">
                    🤖 AI 인사이트
                    <span class="ml-2 text-sm font-normal text-blue-600">키워드 분석 기반 자동 생성</span>
                </h3>
            </div>
            <div class="p-6">
                <div id="aiInsights" class="space-y-3">
                    <div class="text-center text-blue-600">키워드를 분석하여 인사이트를 생성하는 중...</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Channel Distribution -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">채널별 접수 현황</h3>
                </div>
                <div class="p-6">
                    <canvas id="channelChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Status Distribution -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">상태별 분포</h3>
                </div>
                <div class="p-6">
                    <canvas id="statusChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Priority Distribution -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">우선순위별 분포</h3>
                </div>
                <div class="p-6">
                    <canvas id="priorityChart" width="400" height="300"></canvas>
                </div>
            </div>

            <!-- Daily Trend -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">일별 접수 추이</h3>
                </div>
                <div class="p-6">
                    <canvas id="trendChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Unit Analytics Section -->
        <div class="bg-white shadow rounded-lg mb-8">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">🏢 아파트 동/호수별 접수 현황</h3>
                    <p class="text-sm text-gray-500 mt-1">가장 많이 접수하는 세대 및 상세 이력</p>
                </div>
                <div class="flex space-x-2">
                    <button id="exportUnits" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 text-sm">
                        📊 세대별 데이터 내보내기
                    </button>
                    <button id="testModalBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm">
                        🧪 테스트 모달
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Unit Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm font-medium text-blue-900">활성 세대 수</div>
                        <div class="text-2xl font-bold text-blue-600" id="totalActiveUnits">-</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-sm font-medium text-green-900">평균 접수/세대</div>
                        <div class="text-2xl font-bold text-green-600" id="avgRequestsPerUnit">-</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-sm font-medium text-purple-900">최다 접수 동</div>
                        <div class="text-2xl font-bold text-purple-600" id="mostActiveBuilding">-</div>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <div class="text-sm font-medium text-orange-900">피크 시간대</div>
                        <div class="text-2xl font-bold text-orange-600" id="peakPeriod">-</div>
                    </div>
                </div>

                <!-- Top Units Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">순위</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">세대</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">접수 건수</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">최근 접수</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">주요 카테고리</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상세 보기</th>
                            </tr>
                        </thead>
                        <tbody id="topUnitsTable" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    데이터를 로딩하는 중...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Empty State -->
                <div id="unitsEmptyState" class="text-center py-8 hidden">
                    <div class="text-gray-400 text-lg mb-2">🏢</div>
                    <div class="text-gray-500">아파트 동/호수 정보가 있는 접수가 없습니다.</div>
                    <div class="text-sm text-gray-400 mt-1">메시지에 "101동 1502호"와 같은 형식으로 작성된 접수만 표시됩니다.</div>
                </div>
            </div>
        </div>

        <!-- Ticket Detail Modal -->
        <div id="ticketDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 9999;">
            <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h3 class="text-lg font-medium text-gray-900" id="ticketModalTitle">티켓 상세 정보</h3>
                        <button id="closeTicketModal" class="text-gray-400 hover:text-gray-600">
                            <span class="sr-only">닫기</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="mt-4" id="ticketModalContent">
                        <!-- Loading state -->
                        <div id="ticketModalLoading" class="text-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                            <p class="mt-2 text-gray-600">티켓 정보를 불러오는 중...</p>
                        </div>

                        <!-- Ticket details will be loaded here -->
                        <div id="ticketModalDetails" class="hidden">
                            <!-- Ticket Info Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-blue-900">티켓 번호</div>
                                    <div class="text-lg font-bold text-blue-600" id="ticketNumber">-</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-green-900">상태</div>
                                    <div class="text-lg font-bold text-green-600" id="ticketStatus">-</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-purple-900">우선순위</div>
                                    <div class="text-lg font-bold text-purple-600" id="ticketPriority">-</div>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg">
                                    <div class="text-sm font-medium text-orange-900">카테고리</div>
                                    <div class="text-lg font-bold text-orange-600" id="ticketCategory">-</div>
                                </div>
                            </div>

                            <!-- Ticket Details -->
                            <div class="bg-white border rounded-lg p-6 mb-4">
                                <h4 class="text-lg font-medium text-gray-900 mb-4">티켓 정보</h4>
                                <div class="space-y-3">
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">제목:</span>
                                        <span class="ml-2 text-sm text-gray-900" id="ticketTitle">-</span>
                                    </div>
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">설명:</span>
                                        <div class="ml-2 mt-1 text-sm text-gray-900" id="ticketDescription">-</div>
                                    </div>
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">신고자:</span>
                                        <span class="ml-2 text-sm text-gray-900" id="ticketReporter">-</span>
                                    </div>
                                    <div>
                                        <span class="text-sm font-medium text-gray-700">생성일:</span>
                                        <span class="ml-2 text-sm text-gray-900" id="ticketCreated">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex justify-end space-x-3">
                                <button id="openFullTicketBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                                    전체 티켓 페이지 열기
                                </button>
                                <button id="closeTicketModalBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                    닫기
                                </button>
                            </div>
                        </div>

                        <!-- Error state -->
                        <div id="ticketModalError" class="hidden text-center py-8">
                            <div class="text-red-600 text-4xl mb-4">⚠️</div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">티켓을 찾을 수 없습니다</h4>
                            <p class="text-gray-600 mb-4" id="ticketErrorMessage">해당 메시지의 티켓이 존재하지 않습니다.</p>
                            <button id="closeTicketErrorBtn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                                닫기
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unit History Modal -->
        <div id="unitHistoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 9000;">
            <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center pb-3 border-b">
                        <h3 class="text-lg font-medium text-gray-900" id="modalUnitTitle">세대별 접수 이력</h3>
                        <button id="closeModal" class="text-gray-400 hover:text-gray-600">
                            <span class="sr-only">닫기</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Modal Content -->
                    <div class="mt-4">
                        <!-- Unit Info -->
                        <div id="modalUnitInfo" class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="font-medium text-gray-700">동:</span>
                                    <span id="modalDong" class="ml-1">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">호수:</span>
                                    <span id="modalHo" class="ml-1">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">층:</span>
                                    <span id="modalFloor" class="ml-1">-</span>
                                </div>
                                <div>
                                    <span class="font-medium text-gray-700">총 접수:</span>
                                    <span id="modalTotalRequests" class="ml-1 font-semibold text-blue-600">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- History Table -->
                        <div class="overflow-x-auto max-h-96">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">날짜/시간</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">채널</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">카테고리</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">상태</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">내용</th>
                                    </tr>
                                </thead>
                                <tbody id="modalHistoryTable" class="bg-white divide-y divide-gray-200">
                                    <tr>
                                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                                            이력을 로딩하는 중...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div id="modalPagination" class="flex justify-between items-center mt-4 pt-4 border-t">
                            <div class="text-sm text-gray-700">
                                <span id="modalPageInfo">페이지 정보</span>
                            </div>
                            <div class="flex space-x-2">
                                <button id="modalPrevPage" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                                    이전
                                </button>
                                <button id="modalNextPage" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                                    다음
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keyword Analysis -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Top Keywords -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">상위 키워드 순위</h3>
                    <p class="text-sm text-gray-500 mt-1">가장 자주 언급되는 키워드 TOP 10 (분류 가중치 포함)</p>
                    <div class="mt-2 p-2 bg-blue-50 rounded-md">
                        <p class="text-xs text-blue-700">
                            💡 <strong>카운트 방식:</strong> 메시지 분류(×3) + 내용 언급(×1)으로 계산됩니다. 
                            현재 <span class="font-semibold">11개 메시지</span>에서 분석된 결과입니다.
                        </p>
                    </div>
                </div>
                <div class="p-6">
                    <div id="topKeywords" class="space-y-3">
                        <div class="text-center text-gray-500">데이터를 분석하는 중...</div>
                    </div>
                </div>
            </div>

            <!-- Category Keywords -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">카테고리별 주요 키워드</h3>
                    <p class="text-sm text-gray-500 mt-1">분야별 자주 언급되는 키워드</p>
                </div>
                <div class="p-6">
                    <div id="categoryKeywords" class="space-y-4">
                        <div class="text-center text-gray-500">데이터를 분석하는 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Data Table -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">상세 데이터</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">접수일시</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">채널</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">내용</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">우선순위</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">상태</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">분류</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentData = [];
        let charts = {};
        let wordCloudInstance = null;

        // Wait for libraries to load
        function waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max wait time
                
                const checkLibraries = () => {
                    attempts++;
                    const chartReady = typeof Chart !== 'undefined';
                    const wordCloudReady = typeof WordCloud !== 'undefined';
                    
                    console.log(`📚 Attempt ${attempts}: Chart.js available:`, chartReady, ', WordCloud available:', wordCloudReady);
                    
                    if (chartReady && wordCloudReady) {
                        console.log('✅ All libraries loaded successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.log('⏰ Timeout waiting for libraries');
                        reject(new Error('Timeout waiting for libraries to load'));
                    } else {
                        setTimeout(checkLibraries, 100);
                    }
                };
                checkLibraries();
            });
        }

        // Initialize date inputs with default values
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Reports page loaded');
            
            // Set default date range (last 7 days)
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            // Load data immediately without waiting for external libraries
            console.log('📊 Auto-loading data on page load...');
            setTimeout(() => {
                loadReportData();
            }, 500); // Small delay to ensure DOM is fully ready
        });

        function showLoadingInSections() {
            // Show loading in keyword sections
            const topKeywordsDiv = document.getElementById('topKeywords');
            if (topKeywordsDiv) {
                topKeywordsDiv.innerHTML = '<div class="text-center text-blue-600 py-4">⏳ 키워드 분석 중...</div>';
            }
            
            const categoryKeywordsDiv = document.getElementById('categoryKeywords');
            if (categoryKeywordsDiv) {
                categoryKeywordsDiv.innerHTML = '<div class="text-center text-blue-600 py-4">⏳ 카테고리 분석 중...</div>';
            }
            
            // Show loading in trend chart (without destroying the canvas)
            const trendChart = document.getElementById('trendChart');
            if (trendChart) {
                // Hide the canvas and show loading message
                trendChart.style.display = 'none';
                
                // Add loading message if it doesn't exist
                let loadingDiv = trendChart.parentElement.querySelector('.trend-loading');
                // Loading message removed - charts load fast enough
            }
        }

        // Load report data
        async function loadReportData() {
            try {
                console.log('🚀 Loading report data...');
                
                // Show loading status
                const statusEl = document.getElementById('dataStatus');
                if (statusEl) {
                    statusEl.textContent = '⏳ 데이터 로딩 중...';
                    statusEl.className = 'text-sm text-blue-600';
                    statusEl.classList.remove('hidden');
                }
                
                // Show loading in sections
                showLoadingInSections();
                
                // Get filter values
                const filters = getFilterValues();
                console.log('🔍 Filters:', filters);
                
                // Load messages data (request more messages for better analysis)
                const messagesResponse = await fetch('/api/intake/messages?limit=1000');
                console.log('📡 Messages response status:', messagesResponse.status);
                
                const messagesData = await messagesResponse.json();
                console.log('📊 Messages data:', messagesData);
                
                if (messagesData.success) {
                    currentData = messagesData.data || [];
                    console.log('✅ Loaded', currentData.length, 'messages');
                    
                    // Safety check for currentData
                    if (!Array.isArray(currentData)) {
                        console.error('❌ currentData is not an array:', currentData);
                        currentData = [];
                    }
                    
                    // Apply filters
                    const filteredData = applyFilters(currentData, filters);
                    console.log('🔍 Filtered to', filteredData.length, 'messages');
                    
                    // Update statistics
                    try {
                        updateStatistics(filteredData);
                        console.log('✅ Statistics updated');
                    } catch (error) {
                        console.error('❌ Error updating statistics:', error);
                    }
                    
                    // Update charts
                    try {
                        console.log('📊 About to update charts with', filteredData.length, 'items');
                        updateCharts(filteredData);
                        console.log('✅ Charts updated');
                    } catch (error) {
                        console.error('❌ Error updating charts:', error);
                    }
                    
                    // Update word cloud
                    try {
                        await updateWordCloud(filteredData);
                        console.log('✅ Word cloud updated');
                    } catch (error) {
                        console.error('❌ Error updating word cloud:', error);
                    }
                    
                    // Update table
                    try {
                        updateDataTable(filteredData);
                        console.log('✅ Data table updated');
                    } catch (error) {
                        console.error('❌ Error updating data table:', error);
                    }
                    
                    // Show success status
                    const statusEl = document.getElementById('dataStatus');
                    statusEl.textContent = `✅ ${filteredData.length}개 메시지 로드 완료`;
                    statusEl.className = 'text-sm text-green-600';
                } else {
                    console.error('❌ Failed to load messages:', messagesData);
                    const statusEl = document.getElementById('dataStatus');
                    statusEl.textContent = '❌ 데이터 로드 실패';
                    statusEl.className = 'text-sm text-red-600';
                }
                
                // Load SLA data
                const slaResponse = await fetch('/api/tickets/sla/dashboard');
                if (slaResponse.ok) {
                    const slaData = await slaResponse.json();
                    if (slaData.success) {
                        document.getElementById('slaCompliance').textContent = (slaData.data.slaPerformance || 0).toFixed(1) + '%';
                    }
                }
                
            } catch (error) {
                console.error('Error loading report data:', error);
                
                // Ensure currentData is always an array even on error
                if (!Array.isArray(currentData)) {
                    currentData = [];
                }
                
                const statusEl = document.getElementById('dataStatus');
                statusEl.textContent = '❌ 로딩 중 오류 발생';
                statusEl.className = 'text-sm text-red-600';
            }
        }

        function getFilterValues() {
            return {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                channel: document.getElementById('channelFilter').value,
                status: document.getElementById('statusFilter').value,
                priority: document.getElementById('priorityFilter').value
            };
        }

        function applyFilters(data, filters) {
            // Safety check for undefined or null data
            if (!data || !Array.isArray(data)) {
                console.warn('⚠️ applyFilters called with invalid data:', data);
                return [];
            }
            
            return data.filter(item => {
                const itemDate = new Date(item.createdAt).toISOString().split('T')[0];
                
                // Date range filter
                if (filters.startDate && itemDate < filters.startDate) return false;
                if (filters.endDate && itemDate > filters.endDate) return false;
                
                // Channel filter
                if (filters.channel && item.channel !== filters.channel) return false;
                
                // Status filter
                if (filters.status && item.status !== filters.status) return false;
                
                // Priority filter
                if (filters.priority && item.priority !== filters.priority) return false;
                
                return true;
            });
        }

        function updateStatistics(data) {
            document.getElementById('totalMessages').textContent = data.length;
            
            const processedCount = data.filter(item => item.status === 'processed').length;
            document.getElementById('processedMessages').textContent = processedCount;
            
            // Calculate average processing time (placeholder)
            document.getElementById('avgProcessingTime').textContent = '2.5시간';
        }

        function updateCharts(data) {
            console.log('📊 updateCharts called with', data.length, 'items');
            console.log('📊 Chart.js available:', typeof Chart !== 'undefined');
            
            // Try Chart.js first for better visuals, fallback to HTML if needed
            if (typeof Chart !== 'undefined') {
                console.log('📊 Using Chart.js for pie charts');
                
                // Update each chart individually with error handling
                try {
                    updateChannelChart(data);
                    console.log('✅ Channel chart updated');
                } catch (error) {
                    console.error('❌ Channel chart failed:', error);
                }
                
                try {
                    updateStatusChart(data);
                    console.log('✅ Status chart updated');
                } catch (error) {
                    console.error('❌ Status chart failed:', error);
                }
                
                try {
                    updatePriorityChart(data);
                    console.log('✅ Priority chart updated');
                } catch (error) {
                    console.error('❌ Priority chart failed:', error);
                }
                
                try {
                    updateTrendChart(data);
                    console.log('✅ Trend chart updated');
                } catch (error) {
                    console.error('❌ Trend chart failed:', error);
                }
                
                console.log('✅ All Chart.js charts processing completed');
            } else {
                console.log('📊 Chart.js not available, using fallback charts');
                updateFallbackCharts(data);
            }
        }
        
        function updateFallbackCharts(data) {
            console.log('📊 updateFallbackCharts called with', data.length, 'items');
            
            try {
                console.log('📊 Updating fallback channel chart...');
                updateFallbackChannelChart(data);
                
                console.log('📊 Updating fallback status chart...');
                updateFallbackStatusChart(data);
                
                console.log('📊 Updating fallback priority chart...');
                updateFallbackPriorityChart(data);
                
                console.log('📊 Updating fallback trend chart...');
                updateFallbackTrendChart(data);
                
                console.log('✅ All fallback charts completed');
            } catch (error) {
                console.error('❌ Error in updateFallbackCharts:', error);
            }
        }
        
        function updateFallbackChannelChart(data) {
            const channelCounts = {};
            data.forEach(item => {
                channelCounts[item.channel] = (channelCounts[item.channel] || 0) + 1;
            });
            
            const canvas = document.getElementById('channelChart');
            if (!canvas) {
                console.error('❌ channelChart canvas not found');
                return;
            }
            const container = canvas.parentElement;
            if (!container) {
                console.error('❌ channelChart container not found');
                return;
            }
            
            // Replace canvas with HTML chart
            container.innerHTML = `
                <div class="space-y-3">
                    ${Object.entries(channelCounts).map(([channel, count]) => {
                        const percentage = (count / data.length * 100).toFixed(1);
                        const channelNames = { sms: 'SMS', email: '이메일', web: '웹폼', call: '통화' };
                        const colors = { sms: 'bg-blue-500', email: 'bg-green-500', web: 'bg-yellow-500', call: 'bg-red-500' };
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${channelNames[channel] || channel}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="${colors[channel] || 'bg-gray-500'} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}건 (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function updateFallbackStatusChart(data) {
            const statusCounts = {};
            data.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });
            
            const canvas = document.getElementById('statusChart');
            if (!canvas) {
                console.error('❌ statusChart canvas not found');
                return;
            }
            const container = canvas.parentElement;
            if (!container) {
                console.error('❌ statusChart container not found');
                return;
            }
            const statusLabels = { pending: '대기중', classified: '분류완료', assigned: '할당됨', processed: '처리완료' };
            const statusColors = { pending: 'bg-gray-500', classified: 'bg-blue-500', assigned: 'bg-purple-500', processed: 'bg-green-500' };
            
            container.innerHTML = `
                <div class="space-y-3">
                    ${Object.entries(statusCounts).map(([status, count]) => {
                        const percentage = (count / data.length * 100).toFixed(1);
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${statusLabels[status] || status}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="${statusColors[status] || 'bg-gray-500'} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}건 (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function updateFallbackPriorityChart(data) {
            const priorityCounts = {};
            data.forEach(item => {
                priorityCounts[item.priority] = (priorityCounts[item.priority] || 0) + 1;
            });
            
            const canvas = document.getElementById('priorityChart');
            if (!canvas) {
                console.error('❌ priorityChart canvas not found');
                return;
            }
            const container = canvas.parentElement;
            if (!container) {
                console.error('❌ priorityChart container not found');
                return;
            }
            const priorityLabels = { urgent: '긴급', high: '높음', medium: '보통', low: '낮음' };
            const priorityColors = { urgent: 'bg-red-500', high: 'bg-orange-500', medium: 'bg-yellow-500', low: 'bg-green-500' };
            
            container.innerHTML = `
                <div class="space-y-3">
                    ${Object.entries(priorityCounts).map(([priority, count]) => {
                        const percentage = (count / data.length * 100).toFixed(1);
                        return `
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${priorityLabels[priority] || priority}</span>
                                <div class="flex items-center space-x-2">
                                    <div class="w-32 bg-gray-200 rounded-full h-2">
                                        <div class="${priorityColors[priority] || 'bg-gray-500'} h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-600">${count}건 (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function updateFallbackTrendChart(data) {
            console.log('📈 🚨 FALLBACK updateFallbackTrendChart called with', data.length, 'messages');
            console.log('📈 🚨 This should NOT be called if Chart.js is working!');
            
            try {
                // Find container by looking for the trend chart section title
                const trendSection = Array.from(document.querySelectorAll('h3')).find(h3 => 
                    h3.textContent.includes('일별 접수 추이')
                );
                
                if (!trendSection) {
                    console.error('❌ Could not find trend chart section');
                    return;
                }
                
                // Find the container (should be the parent's next sibling with class p-6)
                const container = trendSection.parentElement.nextElementSibling;
                if (!container) {
                    console.error('❌ trendChart container not found');
                    return;
                }
                
                console.log('✅ Found trend chart container:', container);
                
                // FORCE CLEAR: Remove all content and start fresh
                container.innerHTML = '';
                console.log('🧹 Cleared container completely');
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">선택한 기간에 데이터가 없습니다.<br><small class="text-xs">다른 날짜 범위를 선택해보세요.</small></div>';
                    console.log('📈 No data - showing empty message');
                    return;
                }
                
                // Simple approach: count messages by date
                const dailyCounts = {};
                data.forEach(item => {
                    try {
                        const date = new Date(item.createdAt).toISOString().split('T')[0];
                        dailyCounts[date] = (dailyCounts[date] || 0) + 1;
                    } catch (e) {
                        console.warn('Invalid date:', item.createdAt);
                    }
                });
                
                console.log('📈 Daily counts:', dailyCounts);
                
                // Get all dates and sort them
                const allDates = Object.keys(dailyCounts).sort();
                if (allDates.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 py-8">날짜 데이터가 없습니다.</div>';
                    console.log('📈 No valid dates found');
                    return;
                }
                
                // Use ONLY the dates that have actual data from the filtered dataset
                // Do not add extra dates - show exactly what the user filtered for
                const displayDates = allDates;
                
                const maxCount = Math.max(...Object.values(dailyCounts));
                console.log('📈 Display dates:', displayDates);
                console.log('📈 Max count:', maxCount);
                
                // Generate HTML
                const chartHTML = displayDates.map(date => {
                    const count = dailyCounts[date] || 0;
                    const percentage = maxCount > 0 ? Math.max((count / maxCount * 100), count > 0 ? 5 : 0) : 0;
                    
                    let dateStr;
                    try {
                        dateStr = new Date(date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                    } catch (e) {
                        dateStr = date;
                    }
                    
                    return `
                        <div class="flex items-center justify-between py-2">
                            <span class="text-sm font-medium text-gray-700">${dateStr}</span>
                            <div class="flex items-center space-x-3">
                                <div class="w-24 bg-gray-200 rounded-full h-3">
                                    <div class="bg-purple-500 h-3 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm text-gray-600 w-8 text-right">${count}건</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Create chart directly in container
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="text-align: center; color: #6B7280; font-size: 12px; margin-bottom: 15px;">일별 접수 현황</div>
                        ${chartHTML}
                    </div>
                `;
                
                console.log('📈 Chart HTML created with', displayDates.length, 'dates');
                
                console.log('✅ Trend chart updated successfully');
                
            } catch (error) {
                console.error('❌ Error in updateFallbackTrendChart:', error);
                
                // Try to show error message in the trend chart section
                const trendSection = Array.from(document.querySelectorAll('h3')).find(h3 => 
                    h3.textContent.includes('일별 접수 추이')
                );
                
                if (trendSection) {
                    const container = trendSection.parentElement.nextElementSibling;
                    if (container) {
                        container.innerHTML = '<div class="text-center text-red-500 py-8">차트 생성 중 오류가 발생했습니다.</div>';
                    }
                }
            }
        }

        async function updateWordCloud(data) {
            console.log('🔍 Updating word cloud with data:', data.length, 'messages');
            
            // Check if LLM is available for enhanced analysis
            let useLLM = false;
            try {
                // Temporarily disable LLM for reports to prevent hanging
                // TODO: Re-enable once performance is optimized
                const enableLLMForReports = false; // Disabled to prevent hanging
                
                if (enableLLMForReports) {
                    const llmStatusResponse = await fetch('/api/intake/llm/status');
                    const llmStatus = await llmStatusResponse.json();
                    useLLM = llmStatus.success && llmStatus.data.enabled && llmStatus.data.available;
                }
                console.log('🤖 LLM available for enhanced analysis:', useLLM);
            } catch (error) {
                console.log('⚠️ LLM status check failed:', error.message);
            }
            
            // Extract keywords from content and classification categories
            let keywordFrequency = {};
            let analysisMethod = 'basic';
            
            // Try LLM-enhanced keyword extraction first (with timeout)
            if (useLLM) {
                try {
                    console.log('🤖 Using LLM for enhanced keyword extraction...');
                    const messages = data.map(item => item.content || item.maskedContent || '').filter(content => content.length > 0);
                    
                    // Add timeout to prevent hanging
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout
                    
                    const llmResponse = await fetch('/api/intake/llm/keywords', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ messages: messages.slice(0, 50) }), // Reduce to 50 messages for speed
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (llmResponse.ok) {
                        const llmData = await llmResponse.json();
                        if (llmData.success && llmData.data.keywords && llmData.data.keywords.length > 0) {
                            // Use LLM keywords
                            llmData.data.keywords.forEach(kw => {
                                keywordFrequency[kw.keyword] = kw.count;
                            });
                            analysisMethod = 'llm-enhanced';
                            console.log('✅ Using LLM keywords:', Object.keys(keywordFrequency).length, 'keywords');
                        } else {
                            throw new Error('No LLM keywords returned');
                        }
                    } else {
                        throw new Error('LLM API failed');
                    }
                } catch (error) {
                    console.log('⚠️ LLM keyword extraction failed, using basic method:', error.message);
                    useLLM = false;
                }
            }
            
            // Fallback to basic keyword extraction if LLM failed or unavailable
            if (!useLLM || Object.keys(keywordFrequency).length === 0) {
            
            data.forEach(item => {
                // Add classification category as a keyword
                if (item.classification) {
                    const categoryNames = {
                        'billing': '관리비',
                        'maintenance': '수리',
                        'parking': '주차',
                        'noise': '소음',
                        'inquiry': '문의',
                        'complaint': '민원',
                        'facility': '시설',
                        'security': '보안'
                    };
                    const categoryKeyword = categoryNames[item.classification] || item.classification;
                    keywordFrequency[categoryKeyword] = (keywordFrequency[categoryKeyword] || 0) + 3; // Weight categories higher
                }
                
                // Extract meaningful Korean keywords from content
                const content = item.content || item.maskedContent; // Use original content for better keyword extraction
                const keywords = extractKoreanKeywords(content);
                keywords.forEach(keyword => {
                    keywordFrequency[keyword] = (keywordFrequency[keyword] || 0) + 1;
                });
            });
            }
            
            console.log(`📊 Keyword frequency (${analysisMethod}):`, Object.keys(keywordFrequency).length, 'unique keywords');
            const topKeywords = Object.entries(keywordFrequency).sort((a, b) => b[1] - a[1]).slice(0, 10);
            console.log('🔍 Top keywords:', topKeywords);
            console.log('🔍 Top 5 keywords for consistency check:', topKeywords.slice(0, 5).map(([word, count]) => `${word}:${count}`).join(', '));
            
            // Add analysis method indicator to the word cloud
            const methodIndicator = analysisMethod === 'llm-enhanced' ? 
                '🤖 LLM 향상된 분석' : '📝 기본 분석';
            
            // Convert to word cloud format with better filtering
            const meaninglessWords = new Set([
                '문의', '요청', '확인', '부탁', '니다', '습니다', '입니다', '합니다', '됩니다',
                '해주세요', '부탁드려요', '싶습니다', '있습니다', '드립니다', '드려요', '나요',
                '어요', '아요', '네요', '죠', '거예요', '이에요', '예요', '확인부탁', '부탁드립'
            ]);
            
            const wordCloudData = Object.entries(keywordFrequency)
                .filter(([keyword, count]) => {
                    return count >= 1 && 
                           keyword.length >= 2 && 
                           !meaninglessWords.has(keyword) &&
                           !keyword.includes('니다') &&
                           !keyword.includes('부탁') &&
                           !keyword.includes('확인') &&
                           !keyword.includes('문의') &&
                           !keyword.includes('요청') &&
                           !keyword.endsWith('요') &&
                           !keyword.endsWith('네요');
                })
                .sort((a, b) => b[1] - a[1]) // Sort by frequency
                .slice(0, 20) // Top 20 meaningful keywords
                .map(([keyword, count]) => [keyword, Math.max(count * 12, 10)]); // Scale for better visualization

            console.log('☁️ Word cloud data:', wordCloudData.length, 'keywords:', wordCloudData.slice(0, 10));

            // Clear previous word cloud
            const canvas = document.getElementById('wordCloud');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (wordCloudData.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('분석할 데이터가 충분하지 않습니다', canvas.width / 2, canvas.height / 2);
                console.log('⚠️ No word cloud data to display');
                return;
            }

            // Check if WordCloud is available
            if (typeof WordCloud === 'undefined') {
                console.error('❌ WordCloud library not loaded');
                ctx.fillStyle = '#EF4444';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('워드클라우드 라이브러리 로딩 실패', canvas.width / 2, canvas.height / 2);
                return;
            }

            console.log('✅ Generating word cloud...');
            
            // Generate word cloud
            try {
                // Create deterministic color mapping
                const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
                let colorIndex = 0;
                
                WordCloud(canvas, {
                    list: wordCloudData,
                    gridSize: Math.round(16 * canvas.width / 1024),
                    weightFactor: function (size) {
                        return Math.pow(size, 0.8) * canvas.width / 1024;
                    },
                    fontFamily: 'Noto Sans KR, Arial, sans-serif',
                    color: function (word, weight, fontSize, distance, theta) {
                        // Use deterministic color based on word hash
                        let hash = 0;
                        for (let i = 0; i < word.length; i++) {
                            hash = ((hash << 5) - hash + word.charCodeAt(i)) & 0xffffffff;
                        }
                        return colors[Math.abs(hash) % colors.length];
                    },
                    rotateRatio: 0.1, // Reduce rotation for more consistent layout
                    backgroundColor: '#FFFFFF',
                    minSize: 12,
                    drawOutOfBound: false,
                    shuffle: false, // Disable shuffling for consistent positioning
                    rotationSteps: 2 // Limit rotation steps for consistency
                });
                console.log('✅ Word cloud generated successfully');
            } catch (error) {
                console.error('❌ Error generating word cloud:', error);
                console.log('🔄 Falling back to simple text display');
                drawSimpleWordCloud(canvas, wordCloudData);
            }

            // Update stats
            const statsDiv = document.getElementById('wordCloudStats');
            const totalWords = Object.keys(keywordFrequency).length;
            const totalMentions = Object.values(keywordFrequency).reduce((sum, count) => sum + count, 0);
            const topWord = wordCloudData[0];
            
            statsDiv.innerHTML = `
                <div class="flex justify-center space-x-6 text-sm">
                    <span class="${analysisMethod === 'llm-enhanced' ? 'text-green-600' : 'text-gray-600'}">${methodIndicator}</span>
                    <span>총 키워드: <strong>${totalWords}개</strong></span>
                    <span>총 언급: <strong>${totalMentions}회</strong></span>
                    ${topWord ? `<span>최다 언급: <strong>"${topWord[0]}" (${Math.round(topWord[1]/10)}회)</strong></span>` : ''}
                </div>
            `;

            // Debug: Show sample of keyword frequency
            console.log('🔍 Sample keywords from frequency:', Object.entries(keywordFrequency).slice(0, 10));
            
            // Always update keyword sections (even with empty data)
            console.log('🔍 Updating top keywords with frequency data:', Object.keys(keywordFrequency).length, 'keywords');
            try {
                updateTopKeywords(keywordFrequency);
                console.log('✅ Top keywords section updated');
            } catch (error) {
                console.error('❌ Error updating top keywords:', error);
            }
            
            // Update category keywords section  
            console.log('📊 Updating category keywords');
            try {
                updateCategoryKeywords(keywordFrequency);
                console.log('✅ Category keywords section updated');
            } catch (error) {
                console.error('❌ Error updating category keywords:', error);
            }
            
            // Generate AI insights
            console.log('🤖 Generating AI insights');
            try {
                generateAIInsights(keywordFrequency, currentData);
                console.log('✅ AI insights generated');
            } catch (error) {
                console.error('❌ Error generating AI insights:', error);
            }
        }

        function extractKoreanKeywords(text) {
            // Extract meaningful Korean apartment management keywords
            const apartmentKeywords = [
                // Facilities
                '엘리베이터', '승강기', '주차장', '주차', '택배보관함', '택배함', '우편함', 
                '관리사무소', '경비실', '로비', '복도', '계단', '옥상', '지하실', '창고',
                
                // Utilities & Systems  
                '난방', '냉방', '에어컨', '보일러', '온수', '냉수', '수도', '전기', '가스',
                '인터넷', '케이블', '전화', '인터폰', '방송', '조명', '환기', '정전', '복구',
                
                // Maintenance Issues
                '고장', '수리', '점검', '교체', '청소', '정비', '보수', '누수', '막힘',
                '소음', '진동', '냄새', '곰팡이', '습기', '균열', '파손', '방음',
                
                // Services & Fees
                '관리비', '공과금', '수도요금', '전기요금', '가스요금', '주차비', '영수증', '재발급',
                '청소비', '보안비', '수선충당금', '장기수선충당금', '할인', '요금', '월정액',
                
                // Security & Safety
                '보안', '방범', 'CCTV', '출입', '출입문', '비밀번호', '카드키', 
                '화재', '소방', '비상구', '안전', '사고', '도난',
                
                // Community & Rules
                '민원', '분리수거', '쓰레기', '재활용', '반려동물', '애완동물',
                '흡연', '금연', '주민', '입주민', '이사', '입주', '퇴거', '커뮤니티', '활동', '참여',
                '불법주차', '금연구역', '온도조절',
                
                // Common Issues (only meaningful ones)
                '신고', '불만', '개선', '해결', '처리', '조치', '대응', '안내', '공지', '추천', '업체'
            ];
            
            const foundKeywords = [];
            
            // Find exact matches for apartment keywords
            apartmentKeywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    foundKeywords.push(keyword);
                }
            });
            
            // Extract compound Korean words (2-4 characters)
            const koreanWords = text.match(/[가-힣]{2,4}/g) || [];
            const stopwords = new Set([
                // Polite expressions and common phrases
                '문의', '요청', '확인', '부탁', '니다', '습니다', '입니다', '합니다', '됩니다', 
                '해주세요', '부탁드려요', '감사합니다', '안녕하세요', '죄송합니다', '실례합니다',
                '확인해주세요', '알려주세요', '도와주세요', '부탁드립니다', '싶습니다', '있습니다',
                
                // Question words and pronouns
                '언제', '어디', '얼마', '어떻게', '무엇', '누구', '왜', '어느', '몇개', '몇명',
                '이것', '그것', '저것', '여기', '거기', '저기', '이거', '그거', '저거',
                
                // Particles and connectors
                '때문', '위해', '통해', '대해', '관해', '에서', '에게', '한테', '께서', '에는',
                '으로', '로서', '부터', '까지', '처럼', '같이', '함께', '그리고', '그런데',
                '하지만', '그러나', '또한', '그래서', '따라서', '그러면', '만약',
                
                // Common verbs and adjectives (endings)
                '있나요', '없나요', '되나요', '하나요', '인가요', '나요', '어요', '아요', '네요',
                '거예요', '이에요', '예요', '이야', '야', '지요', '죠', '거든요', '든요',
                
                // Time and quantity words
                '지금', '오늘', '내일', '어제', '이번', '다음', '저번', '올해', '작년', '내년',
                '아침', '점심', '저녁', '밤', '새벽', '오전', '오후', '시간', '분', '초',
                '하나', '둘', '셋', '넷', '다섯', '여섯', '일곱', '여덟', '아홉', '열',
                
                // Common apartment non-specific words
                '상태', '문제', '경우', '방법', '이유', '결과', '과정', '계획', '준비', '완료',
                '시작', '끝', '중간', '전체', '부분', '일부', '전부', '모든', '각각', '서로',
                
                // Meaningless fragments
                '드려', '드립', '받을', '받는', '주는', '하는', '되는', '있는', '없는', '같은',
                '다른', '새로운', '오래된', '좋은', '나쁜', '큰', '작은', '많은', '적은'
            ]);
            
            koreanWords.forEach(word => {
                if (word.length >= 2 && 
                    !foundKeywords.includes(word) && 
                    !stopwords.has(word) &&
                    !/^[0-9]+$/.test(word) &&
                    !word.includes('니다') && // Filter out verb endings
                    !word.includes('습니다') &&
                    !word.includes('입니다') &&
                    !word.includes('합니다') &&
                    !word.includes('부탁') &&
                    !word.includes('확인') &&
                    !word.includes('문의') &&
                    !word.includes('요청') &&
                    !word.endsWith('요') && // Filter out polite endings
                    !word.endsWith('네요') &&
                    !word.endsWith('어요') &&
                    !word.endsWith('아요')) {
                    foundKeywords.push(word);
                }
            });
            
            return [...new Set(foundKeywords)]; // Remove duplicates
        }

        function analyzeWordFrequency(text) {
            console.log('🔍 Analyzing text of length:', text.length);
            
            // Korean text processing
            const frequency = {};
            
            // Remove special characters and normalize
            const cleanText = text
                .replace(/[^\w\s가-힣]/g, ' ')
                .replace(/\s+/g, ' ')
                .toLowerCase()
                .trim();

            console.log('🧹 Clean text length:', cleanText.length);

            // Split into words
            const words = cleanText.split(' ');
            console.log('📝 Total words:', words.length);
            
            // Korean stopwords and common words to filter out
            const stopwords = new Set([
                '이', '그', '저', '것', '수', '있', '없', '하', '되', '된', '될', '는', '은', '이', '가', '을', '를', 
                '에', '에서', '로', '으로', '와', '과', '도', '만', '까지', '부터', '보다', '처럼', '같이', '함께',
                '그리고', '그런데', '하지만', '그러나', '또한', '또', '및', '등', '즉', '예를들어',
                '있습니다', '습니다', '입니다', '합니다', '됩니다', '니다', '세요', '요', '네요', '어요',
                '때문', '위해', '통해', '대해', '관해', '따라', '의해', '에게', '한테', '께', '에서',
                '년', '월', '일', '시', '분', '초', '오전', '오후', '아침', '점심', '저녁', '밤',
                '층', '호', '동', '번', '개', '명', '분', '시간', '날', '주', '달',
                '안녕하세요', '감사합니다', '죄송합니다', '실례합니다', '부탁드립니다', '확인', '문의', '신고'
            ]);

            // Count word frequency
            words.forEach(word => {
                if (word.length >= 2 && !stopwords.has(word) && !/^\d+$/.test(word)) {
                    frequency[word] = (frequency[word] || 0) + 1;
                }
            });

            // Filter out very rare words (appear only once) unless they're important keywords
            const importantKeywords = new Set([
                '엘리베이터', '주차', '소음', '관리비', '보안', '출입', '화재', '가스', '누수', '고장', '수리',
                '청소', '쓰레기', '분리수거', '택배', '방문', '공사', '시설', '전기', '수도', '난방',
                '에어컨', '인터넷', '전화', '도어락', 'cctv', '방범', '순찰', '민원', '불만', '개선'
            ]);

            const filteredFrequency = {};
            Object.entries(frequency).forEach(([word, count]) => {
                if (count > 1 || importantKeywords.has(word)) {
                    filteredFrequency[word] = count;
                }
            });

            return filteredFrequency;
        }

        function drawSimpleWordCloud(canvas, wordCloudData) {
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw background
            ctx.fillStyle = '#F9FAFB';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4'];
            let currentY = 50;
            let currentX = 50;
            const maxWidth = canvas.width - 100;
            
            // Sort wordCloudData by word for consistent positioning
            const sortedWordCloudData = [...wordCloudData].sort((a, b) => a[0].localeCompare(b[0]));
            
            sortedWordCloudData.forEach(([word, size], index) => {
                const fontSize = Math.max(12, Math.min(48, size / 10));
                ctx.font = `${fontSize}px Noto Sans KR, Arial, sans-serif`;
                // Use deterministic color based on word
                let hash = 0;
                for (let i = 0; i < word.length; i++) {
                    hash = ((hash << 5) - hash + word.charCodeAt(i)) & 0xffffffff;
                }
                ctx.fillStyle = colors[Math.abs(hash) % colors.length];
                
                const textWidth = ctx.measureText(word).width;
                
                // Check if word fits on current line
                if (currentX + textWidth > maxWidth) {
                    currentX = 50;
                    currentY += fontSize + 10;
                }
                
                // Don't draw if we're out of canvas bounds
                if (currentY > canvas.height - 50) return;
                
                ctx.fillText(word, currentX, currentY);
                currentX += textWidth + 20;
            });
            
            // Add title
            ctx.font = '16px Arial';
            ctx.fillStyle = '#6B7280';
            ctx.textAlign = 'center';
            ctx.fillText('주요 키워드 (간단 표시)', centerX, 25);
            ctx.textAlign = 'left';
        }

        function updateTopKeywords(wordFrequency) {
            const topKeywordsDiv = document.getElementById('topKeywords');
            console.log('🔍 updateTopKeywords called with:', Object.keys(wordFrequency).length, 'keywords');
            
            // Apply the same filtering as word cloud
            const meaninglessWords = new Set([
                '문의', '요청', '확인', '부탁', '니다', '습니다', '입니다', '합니다', '됩니다',
                '해주세요', '부탁드려요', '싶습니다', '있습니다', '드립니다', '드려요', '나요',
                '어요', '아요', '네요', '죠', '거예요', '이에요', '예요', '확인부탁', '부탁드립'
            ]);
            
            const sortedKeywords = Object.entries(wordFrequency)
                .filter(([keyword, count]) => {
                    return count >= 1 && 
                           keyword.length >= 2 && 
                           !meaninglessWords.has(keyword) &&
                           !keyword.includes('니다') &&
                           !keyword.includes('부탁') &&
                           !keyword.includes('확인') &&
                           !keyword.includes('문의') &&
                           !keyword.includes('요청') &&
                           !keyword.endsWith('요') &&
                           !keyword.endsWith('네요');
                })
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
                
            console.log('🔍 Filtered keywords for top list:', sortedKeywords.length);

            if (sortedKeywords.length === 0) {
                const totalKeywords = Object.keys(wordFrequency).length;
                const message = totalKeywords === 0 
                    ? '선택한 기간에 데이터가 없습니다. 다른 날짜 범위를 선택해보세요.' 
                    : '의미있는 키워드가 없습니다. (일반적인 표현만 발견됨)';
                topKeywordsDiv.innerHTML = `<div class="text-center text-gray-500 py-4">${message}</div>`;
                return;
            }

            const maxCount = sortedKeywords[0][1];
            
            topKeywordsDiv.innerHTML = sortedKeywords.map(([keyword, count], index) => {
                const percentage = (count / maxCount) * 100;
                
                return `
                    <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-medium text-gray-900">${keyword}</div>
                                <div class="text-sm text-gray-500">${count}회 언급</div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 w-20">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-indigo-500 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

        }

        function updateCategoryKeywords(wordFrequency) {
            const categoryKeywordsDiv = document.getElementById('categoryKeywords');
            console.log('📊 updateCategoryKeywords called with:', Object.keys(wordFrequency).length, 'keywords');
            
            // Define keyword categories
            const categories = {
                '시설관리': ['엘리베이터', '고장', '수리', '전기', '수도', '난방', '에어컨', '시설', '공사', '청소'],
                '소음': ['소음', '시끄', '층간소음', '윗집', '아래집', '밤', '새벽', '음악', '발소리'],
                '주차': ['주차', '차량', '주차장', '주차위반', '불법주차', '주차공간', '자동차', '오토바이'],
                '관리비': ['관리비', '요금', '청구서', '납부', '연체', '할인', '요금표', '계산서'],
                '보안': ['보안', '출입', '도어락', '키', '분실', 'cctv', '방범', '순찰', '안전'],
                '생활편의': ['택배', '방문', '쓰레기', '분리수거', '인터넷', '전화', '방송', '공지']
            };

            const categoryStats = {};
            
            // Calculate category statistics
            Object.entries(categories).forEach(([category, keywords]) => {
                let totalCount = 0;
                const foundKeywords = [];
                
                keywords.forEach(keyword => {
                    if (wordFrequency[keyword]) {
                        totalCount += wordFrequency[keyword];
                        foundKeywords.push({ keyword, count: wordFrequency[keyword] });
                    }
                });
                
                if (totalCount > 0) {
                    categoryStats[category] = {
                        totalCount,
                        keywords: foundKeywords.sort((a, b) => b.count - a.count).slice(0, 3)
                    };
                    console.log(`📊 Category ${category}: ${totalCount} total, keywords:`, foundKeywords.map(k => k.keyword));
                }
            });

            if (Object.keys(categoryStats).length === 0) {
                const totalKeywords = Object.keys(wordFrequency).length;
                const message = totalKeywords === 0 
                    ? '선택한 기간에 데이터가 없습니다. 다른 날짜 범위를 선택해보세요.' 
                    : '아파트 관리 관련 키워드가 없습니다.';
                categoryKeywordsDiv.innerHTML = `<div class="text-center text-gray-500 py-4">${message}</div>`;
                return;
            }

            const maxCategoryCount = Math.max(...Object.values(categoryStats).map(cat => cat.totalCount));

            categoryKeywordsDiv.innerHTML = Object.entries(categoryStats)
                .sort((a, b) => b[1].totalCount - a[1].totalCount)
                .map(([category, stats]) => {
                    const percentage = (stats.totalCount / maxCategoryCount) * 100;
                    const categoryColors = {
                        '시설관리': 'bg-blue-500',
                        '소음': 'bg-red-500',
                        '주차': 'bg-yellow-500',
                        '관리비': 'bg-green-500',
                        '보안': 'bg-purple-500',
                        '생활편의': 'bg-indigo-500'
                    };
                    const color = categoryColors[category] || 'bg-gray-500';
                    
                    return `
                        <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-medium text-gray-900">${category}</h4>
                                <span class="text-sm text-gray-500">${stats.totalCount}회</span>
                            </div>
                            <div class="mb-3">
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${color} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                ${stats.keywords.map(({ keyword, count }) => `
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                        ${keyword} (${count})
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function generateAIInsights(wordFrequency, data) {
            const insightsDiv = document.getElementById('aiInsights');
            const insights = [];

            // Analyze top issues
            const topKeywords = Object.entries(wordFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (topKeywords.length > 0) {
                const topIssue = topKeywords[0];
                insights.push({
                    icon: '🔍',
                    title: '주요 이슈 분석',
                    content: `"${topIssue[0]}"가 ${topIssue[1]}회로 가장 많이 언급되었습니다. 이 분야에 대한 집중적인 관리가 필요합니다.`
                });
            }

            // Analyze urgency patterns
            const urgentCount = data.filter(item => item.priority === 'urgent').length;
            const highCount = data.filter(item => item.priority === 'high').length;
            const totalCount = data.length;

            if (totalCount > 0) {
                const urgencyRate = ((urgentCount + highCount) / totalCount * 100).toFixed(1);
                if (urgencyRate > 50) {
                    insights.push({
                        icon: '⚠️',
                        title: '긴급도 분석',
                        content: `전체 요청의 ${urgencyRate}%가 높은 우선순위입니다. 신속한 대응 체계 강화가 필요합니다.`
                    });
                } else {
                    insights.push({
                        icon: '✅',
                        title: '긴급도 분석',
                        content: `전체 요청의 ${urgencyRate}%가 높은 우선순위로 적정 수준입니다.`
                    });
                }
            }

            // Analyze channel patterns
            const channelCounts = {};
            data.forEach(item => {
                channelCounts[item.channel] = (channelCounts[item.channel] || 0) + 1;
            });

            const topChannel = Object.entries(channelCounts)
                .sort((a, b) => b[1] - a[1])[0];

            if (topChannel) {
                const channelNames = { sms: 'SMS', email: '이메일', web: '웹폼', call: '통화' };
                insights.push({
                    icon: '📊',
                    title: '채널 분석',
                    content: `${channelNames[topChannel[0]] || topChannel[0]}를 통한 접수가 ${topChannel[1]}건으로 가장 많습니다. 이 채널의 사용성 개선을 고려해보세요.`
                });
            }

            // Analyze processing efficiency
            const processedCount = data.filter(item => item.status === 'processed').length;
            const processingRate = totalCount > 0 ? (processedCount / totalCount * 100).toFixed(1) : 0;

            if (processingRate < 30) {
                insights.push({
                    icon: '📈',
                    title: '처리 효율성',
                    content: `처리 완료율이 ${processingRate}%로 낮습니다. 업무 프로세스 개선이 필요합니다.`
                });
            } else if (processingRate > 80) {
                insights.push({
                    icon: '🎯',
                    title: '처리 효율성',
                    content: `처리 완료율이 ${processingRate}%로 우수합니다. 현재 프로세스를 유지하세요.`
                });
            }

            // Analyze keyword diversity
            const keywordCount = Object.keys(wordFrequency).length;
            if (keywordCount > 20) {
                insights.push({
                    icon: '🔄',
                    title: '이슈 다양성',
                    content: `${keywordCount}개의 다양한 키워드가 발견되었습니다. 다양한 이슈에 대한 종합적인 대응 방안이 필요합니다.`
                });
            }

            if (insights.length === 0) {
                insightsDiv.innerHTML = '<div class="text-center text-blue-600">분석할 데이터가 충분하지 않습니다.</div>';
                return;
            }

            insightsDiv.innerHTML = insights.map(insight => `
                <div class="flex items-start space-x-3 p-4 bg-white rounded-lg border border-blue-100">
                    <div class="flex-shrink-0 text-2xl">${insight.icon}</div>
                    <div class="flex-1">
                        <h4 class="font-medium text-blue-900">${insight.title}</h4>
                        <p class="text-sm text-blue-700 mt-1">${insight.content}</p>
                    </div>
                </div>
            `).join('');
        }

        function updateChannelChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not available for channel chart');
                return;
            }

            const channelCounts = {};
            data.forEach(item => {
                channelCounts[item.channel] = (channelCounts[item.channel] || 0) + 1;
            });

            const ctx = document.getElementById('channelChart').getContext('2d');
            
            if (charts.channel) {
                charts.channel.destroy();
            }
            
            charts.channel = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(channelCounts).map(channel => {
                        const labels = { sms: 'SMS', email: '이메일', web: '웹폼', call: '통화' };
                        return labels[channel] || channel;
                    }),
                    datasets: [{
                        data: Object.values(channelCounts),
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateStatusChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not available for status chart');
                return;
            }

            const statusCounts = {};
            data.forEach(item => {
                statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (charts.status) {
                charts.status.destroy();
            }
            
            charts.status = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCounts).map(status => {
                        const labels = { pending: '대기중', classified: '분류완료', assigned: '할당됨', processed: '처리완료' };
                        return labels[status] || status;
                    }),
                    datasets: [{
                        label: '건수',
                        data: Object.values(statusCounts),
                        backgroundColor: '#6366F1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updatePriorityChart(data) {
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not available for priority chart');
                return;
            }

            const priorityCounts = {};
            data.forEach(item => {
                priorityCounts[item.priority] = (priorityCounts[item.priority] || 0) + 1;
            });

            const ctx = document.getElementById('priorityChart').getContext('2d');
            
            if (charts.priority) {
                charts.priority.destroy();
            }
            
            charts.priority = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(priorityCounts).map(priority => {
                        const labels = { urgent: '긴급', high: '높음', medium: '보통', low: '낮음' };
                        return labels[priority] || priority;
                    }),
                    datasets: [{
                        data: Object.values(priorityCounts),
                        backgroundColor: ['#DC2626', '#F59E0B', '#10B981', '#6B7280']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function updateTrendChart(data) {
            console.log('📈 updateTrendChart called with', data.length, 'messages');
            console.log('📈 Chart.js available:', typeof Chart !== 'undefined');
            console.log('📈 Canvas element exists:', !!document.getElementById('trendChart'));
            
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js not available for trend chart');
                // Fall back to HTML chart
                updateFallbackTrendChart(data);
                return;
            }

            // Try to find canvas, if not found, use fallback
            const canvas = document.getElementById('trendChart');
            if (!canvas) {
                console.error('❌ trendChart canvas not found, using fallback chart');
                updateFallbackTrendChart(data);
                return;
            }
            
            console.log('✅ Canvas found, proceeding with Chart.js');
            
            if (data.length === 0) {
                console.log('📈 No data provided, showing empty chart');
            }

            // Group data by date
            const dailyCounts = {};
            data.forEach(item => {
                const date = new Date(item.createdAt).toISOString().split('T')[0];
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });

            console.log('📈 Chart.js Daily counts:', dailyCounts);
            
            // Use ONLY the dates that have actual data from the filtered dataset
            const dataDate = Object.keys(dailyCounts).sort();
            console.log('📈 Chart.js Data dates found:', dataDate);
            
            let sortedDates;
            if (dataDate.length === 0) {
                // No data - show empty chart
                sortedDates = [];
            } else {
                // Use exactly the dates that have data - no extra dates
                sortedDates = dataDate;
            }
            
            const counts = sortedDates.map(date => dailyCounts[date] || 0);

            const ctx = canvas.getContext('2d');
            
            if (charts.trend) {
                console.log('📈 🔄 Destroying existing trend chart');
                charts.trend.destroy();
            }
            
            console.log('📈 🆕 Creating new trend chart...');
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates.map(date => new Date(date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: '일별 접수',
                        data: counts,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: true,
                    animation: {
                        duration: 0  // Disable animations to prevent continuous redrawing
                    },
                    interaction: {
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            console.log('📈 ✅ Chart.js trend chart created successfully');
            console.log('📈 ✅ Chart instance:', charts.trend);
            console.log('📈 ✅ Canvas parent:', canvas.parentElement);
            console.log('📈 ✅ Canvas dimensions:', canvas.width, 'x', canvas.height);
            console.log('📈 ✅ Canvas style:', canvas.style.width, 'x', canvas.style.height);
            
            // Force canvas to be visible
            canvas.style.display = 'block';
            canvas.style.width = '100%';
            canvas.style.height = '300px';
        }

        function updateDataTable(data) {
            const tableBody = document.getElementById('dataTable');
            
            if (data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            필터 조건에 맞는 데이터가 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }

            const channelEmojis = { sms: '📱', email: '📧', web: '🌐', call: '📞' };
            const priorityColors = {
                urgent: 'bg-red-100 text-red-800',
                high: 'bg-orange-100 text-orange-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-green-100 text-green-800'
            };
            const statusColors = {
                pending: 'bg-gray-100 text-gray-800',
                classified: 'bg-blue-100 text-blue-800',
                assigned: 'bg-purple-100 text-purple-800',
                processed: 'bg-green-100 text-green-800'
            };
            const statusLabels = {
                pending: '대기중',
                classified: '분류완료',
                assigned: '할당됨',
                processed: '처리완료'
            };

            tableBody.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(item.createdAt).toLocaleString('ko-KR')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${channelEmojis[item.channel] || '📝'} ${item.channel.toUpperCase()}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">
                        ${item.maskedContent || item.content}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityColors[item.priority] || 'bg-gray-100 text-gray-800'}">
                            ${item.priority}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[item.status] || 'bg-gray-100 text-gray-800'}">
                            ${statusLabels[item.status] || item.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${item.classification || '-'}
                    </td>
                </tr>
            `).join('');
        }

        // Event listeners
        document.getElementById('loadData').addEventListener('click', () => {
            console.log('🔄 Manual data load requested');
            loadReportData();
        });
        
        document.getElementById('applyFilters').addEventListener('click', loadReportData);
        
        document.getElementById('resetFilters').addEventListener('click', () => {
            document.getElementById('channelFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('priorityFilter').value = '';
            
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
            
            loadReportData();
        });

        document.getElementById('exportCSV').addEventListener('click', () => {
            const filters = getFilterValues();
            const filteredData = applyFilters(currentData, filters);
            exportToCSV(filteredData);
        });

        document.getElementById('testWordCloud').addEventListener('click', async () => {
            console.log('🧪 Testing word cloud with current data:', currentData.length, 'messages');
            if (currentData.length > 0) {
                await updateWordCloud(currentData);
            } else {
                console.log('📝 No data loaded, using sample Korean apartment terms for testing');
                // Use sample Korean apartment management terms for testing
                const sampleData = [
                    { content: '엘리베이터 고장 신고합니다', classification: { keywords: ['엘리베이터', '고장', '신고'] } },
                    { content: '주차장 불법주차 문제', classification: { keywords: ['주차장', '불법주차', '문제'] } },
                    { content: '소음 민원 접수', classification: { keywords: ['소음', '민원', '접수'] } },
                    { content: '누수 신고 드립니다', classification: { keywords: ['누수', '신고', '수리'] } },
                    { content: '관리비 문의사항', classification: { keywords: ['관리비', '문의', '요금'] } },
                    { content: '택배보관함 고장', classification: { keywords: ['택배보관함', '고장', '수리'] } },
                    { content: '난방 온도 조절 요청', classification: { keywords: ['난방', '온도', '조절'] } },
                    { content: '청소 상태 불만', classification: { keywords: ['청소', '상태', '불만'] } },
                    { content: '보안 문제 신고', classification: { keywords: ['보안', '문제', '신고'] } },
                    { content: '시설 개선 건의', classification: { keywords: ['시설', '개선', '건의'] } }
                ];
                await updateWordCloud(sampleData);
                alert('샘플 데이터로 워드클라우드를 생성했습니다. 실제 데이터를 보려면 먼저 "📊 데이터 로드" 버튼을 클릭하세요.');
            }
        });

        document.getElementById('debugLibraries').addEventListener('click', () => {
            const chartAvailable = typeof Chart !== 'undefined';
            const wordCloudAvailable = typeof WordCloud !== 'undefined';
            
            alert(`라이브러리 상태:
Chart.js: ${chartAvailable ? '✅ 로드됨' : '❌ 로드 실패'}
WordCloud: ${wordCloudAvailable ? '✅ 로드됨' : '❌ 로드 실패'}
데이터: ${currentData.length}개 메시지`);
            
            console.log('🔍 Library debug info:', {
                Chart: typeof Chart,
                WordCloud: typeof WordCloud,
                dataCount: currentData.length
            });
        });

        document.getElementById('testKeywords').addEventListener('click', () => {
            console.log('🔍 Testing keyword extraction...');
            
            // Test with sample text
            const testText = "관리비 영수증 재발급 받을 수 있나요? 엘리베이터가 고장났어요. 주차장 소음이 심해요.";
            const keywords = extractKoreanKeywords(testText);
            console.log('🔍 Extracted keywords from test text:', keywords);
            
            // Test with current data if available
            if (currentData.length > 0) {
                const sampleMessage = currentData[0];
                const sampleKeywords = extractKoreanKeywords(sampleMessage.content);
                console.log('🔍 Sample message:', sampleMessage.content);
                console.log('🔍 Extracted keywords:', sampleKeywords);
                
                // Test the update functions with sample data
                const testFrequency = { '관리비': 5, '엘리베이터': 3, '주차장': 4, '소음': 2, '고장': 3 };
                console.log('🔍 Testing updateTopKeywords with sample data');
                updateTopKeywords(testFrequency);
                
                console.log('🔍 Testing updateCategoryKeywords with sample data');
                updateCategoryKeywords(testFrequency);
            }
            
            alert('키워드 추출 테스트 완료. 콘솔을 확인하세요.');
        });

        document.getElementById('testSections').addEventListener('click', () => {
            console.log('🧪 Testing all sections with sample data...');
            
            // Test data
            const testData = [
                { createdAt: '2025-09-20T10:00:00Z', content: '엘리베이터가 고장났어요', classification: 'maintenance' },
                { createdAt: '2025-09-20T11:00:00Z', content: '주차장 소음이 심해요', classification: 'noise' },
                { createdAt: '2025-09-20T12:00:00Z', content: '관리비 문의드립니다', classification: 'billing' },
                { createdAt: '2025-09-19T14:00:00Z', content: '수리 요청합니다', classification: 'maintenance' },
                { createdAt: '2025-09-18T16:00:00Z', content: '보안 문제 신고', classification: 'security' }
            ];
            
            const testFrequency = { 
                '엘리베이터': 5, '고장': 4, '주차장': 3, '소음': 3, '관리비': 2, 
                '수리': 4, '보안': 2, '문제': 3, '신고': 2 
            };
            
            console.log('🧪 Testing updateTopKeywords...');
            updateTopKeywords(testFrequency);
            
            console.log('🧪 Testing updateCategoryKeywords...');
            updateCategoryKeywords(testFrequency);
            
            console.log('🧪 Testing updateFallbackTrendChart...');
            updateFallbackTrendChart(testData);
            
            alert('섹션 테스트 완료! 상위 키워드, 카테고리별 키워드, 일별 추이가 업데이트되었습니다.');
        });

        document.getElementById('simpleTest').addEventListener('click', () => {
            console.log('✅ Running simple HTML update test...');
            
            // Test 1: Update top keywords directly
            const topKeywordsDiv = document.getElementById('topKeywords');
            if (topKeywordsDiv) {
                topKeywordsDiv.innerHTML = `
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-sm font-bold">1</div>
                            <div>
                                <div class="font-medium text-gray-900">엘리베이터</div>
                                <div class="text-sm text-gray-500">5회 언급</div>
                            </div>
                        </div>
                        <div class="w-20 bg-gray-200 rounded-full h-2">
                            <div class="bg-indigo-500 h-2 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                `;
                console.log('✅ Top keywords updated');
            } else {
                console.error('❌ topKeywords element not found');
            }
            
            // Test 2: Update category keywords directly
            const categoryKeywordsDiv = document.getElementById('categoryKeywords');
            if (categoryKeywordsDiv) {
                categoryKeywordsDiv.innerHTML = `
                    <div class="border rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-900">시설관리</h4>
                            <span class="text-sm text-gray-500">5회</span>
                        </div>
                        <div class="mb-3">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                엘리베이터 (5)
                            </span>
                        </div>
                    </div>
                `;
                console.log('✅ Category keywords updated');
            } else {
                console.error('❌ categoryKeywords element not found');
            }
            
            // Test 3: Update trend chart directly
            const trendChart = document.getElementById('trendChart');
            if (trendChart) {
                const container = trendChart.parentElement;
                container.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">9월 20일</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full" style="width: 100%"></div>
                                </div>
                                <span class="text-sm text-gray-600">5건</span>
                            </div>
                        </div>
                    </div>
                `;
                console.log('✅ Trend chart updated');
            } else {
                console.error('❌ trendChart element not found');
            }
            
            alert('간단 테스트 완료! 모든 섹션이 직접 업데이트되었습니다.');
        });

        document.getElementById('debugFilters').addEventListener('click', () => {
            console.log('🔍 Debugging filters and data flow...');
            
            // Check current filter values
            const filters = getFilterValues();
            console.log('🔍 Current filters:', filters);
            
            // Check current data
            console.log('🔍 Current data length:', currentData.length);
            console.log('🔍 Sample data:', currentData.slice(0, 3));
            
            // Apply filters manually
            const filteredData = applyFilters(currentData, filters);
            console.log('🔍 Filtered data length:', filteredData.length);
            console.log('🔍 Filtered sample:', filteredData.slice(0, 3));
            
            // Test keyword extraction
            if (filteredData.length > 0) {
                console.log('🔍 Testing keyword extraction on filtered data...');
                const keywordFrequency = {};
                
                filteredData.forEach(item => {
                    if (item.classification) {
                        const categoryNames = {
                            'billing': '관리비',
                            'maintenance': '수리',
                            'parking': '주차',
                            'noise': '소음',
                            'inquiry': '문의',
                            'complaint': '민원',
                            'facility': '시설',
                            'security': '보안'
                        };
                        const categoryKeyword = categoryNames[item.classification] || item.classification;
                        keywordFrequency[categoryKeyword] = (keywordFrequency[categoryKeyword] || 0) + 3;
                    }
                    
                    const content = item.content || item.maskedContent;
                    const keywords = extractKoreanKeywords(content);
                    keywords.forEach(keyword => {
                        keywordFrequency[keyword] = (keywordFrequency[keyword] || 0) + 1;
                    });
                });
                
                console.log('🔍 Extracted keyword frequency:', keywordFrequency);
                console.log('🔍 Total unique keywords:', Object.keys(keywordFrequency).length);
                
                // Test updating sections
                console.log('🔍 Testing section updates...');
                updateTopKeywords(keywordFrequency);
                updateCategoryKeywords(keywordFrequency);
                updateFallbackTrendChart(filteredData);
            }
            
            alert('필터 디버그 완료! 콘솔을 확인하세요.');
        });

        document.getElementById('debugFlow').addEventListener('click', () => {
            console.log('🚨 === COMPREHENSIVE DEBUG START ===');
            
            // Step 1: Check if data exists
            console.log('📊 Step 1: Data Check');
            console.log('Current data length:', currentData.length);
            if (currentData.length > 0) {
                console.log('Sample data:', currentData[0]);
            }
            
            // Step 2: Test filters
            console.log('📊 Step 2: Filter Test');
            const filters = getFilterValues();
            console.log('Current filters:', filters);
            const filteredData = applyFilters(currentData, filters);
            console.log('Filtered data length:', filteredData.length);
            
            // Step 3: Test each chart function individually
            console.log('📊 Step 3: Chart Functions Test');
            
            // Test trend chart specifically
            console.log('Testing updateFallbackTrendChart...');
            try {
                updateFallbackTrendChart(filteredData);
                console.log('✅ updateFallbackTrendChart completed');
            } catch (error) {
                console.error('❌ updateFallbackTrendChart failed:', error);
            }
            
            // Test Chart.js version if available
            if (typeof Chart !== 'undefined') {
                console.log('Testing updateTrendChart (Chart.js)...');
                try {
                    updateTrendChart(filteredData);
                    console.log('✅ updateTrendChart completed');
                } catch (error) {
                    console.error('❌ updateTrendChart failed:', error);
                }
            }
            
            // Step 4: Test keyword functions
            console.log('📊 Step 4: Keyword Functions Test');
            
            // Extract keywords manually
            const keywordFrequency = {};
            filteredData.forEach(item => {
                if (item.classification) {
                    const categoryNames = {
                        'billing': '관리비', 'maintenance': '수리', 'parking': '주차',
                        'noise': '소음', 'inquiry': '문의', 'complaint': '민원',
                        'facility': '시설', 'security': '보안'
                    };
                    const categoryKeyword = categoryNames[item.classification] || item.classification;
                    keywordFrequency[categoryKeyword] = (keywordFrequency[categoryKeyword] || 0) + 3;
                }
                
                const content = item.content || item.maskedContent;
                const keywords = extractKoreanKeywords(content);
                keywords.forEach(keyword => {
                    keywordFrequency[keyword] = (keywordFrequency[keyword] || 0) + 1;
                });
            });
            
            console.log('Extracted keywords:', Object.keys(keywordFrequency).length);
            console.log('Sample keywords:', Object.entries(keywordFrequency).slice(0, 5));
            
            // Test keyword functions
            try {
                updateTopKeywords(keywordFrequency);
                console.log('✅ updateTopKeywords completed');
            } catch (error) {
                console.error('❌ updateTopKeywords failed:', error);
            }
            
            try {
                updateCategoryKeywords(keywordFrequency);
                console.log('✅ updateCategoryKeywords completed');
            } catch (error) {
                console.error('❌ updateCategoryKeywords failed:', error);
            }
            
            // Step 5: Check DOM elements
            console.log('📊 Step 5: DOM Elements Check');
            
            // Check trend chart section
            const trendSection = Array.from(document.querySelectorAll('h3')).find(h3 => 
                h3.textContent.includes('일별 접수 추이')
            );
            if (trendSection) {
                const trendContainer = trendSection.parentElement.nextElementSibling;
                if (trendContainer) {
                    console.log('✅ trendChart section and container found');
                } else {
                    console.error('❌ trendChart container NOT found');
                }
            } else {
                console.error('❌ trendChart section NOT found');
            }
            
            // Check other elements
            const elements = {
                'topKeywords': document.getElementById('topKeywords'),
                'categoryKeywords': document.getElementById('categoryKeywords')
            };
            
            Object.entries(elements).forEach(([name, element]) => {
                if (element) {
                    console.log(`✅ ${name} element found`);
                } else {
                    console.error(`❌ ${name} element NOT found`);
                }
            });
            
            console.log('🚨 === COMPREHENSIVE DEBUG END ===');
            alert('전체 디버그 완료! 콘솔을 확인하세요.');
        });

        document.getElementById('fixTrendChart').addEventListener('click', () => {
            console.log('🔧 Forcing trend chart fix...');
            
            // Find the trend chart section by looking for the title
            const trendSection = Array.from(document.querySelectorAll('h3')).find(h3 => 
                h3.textContent.includes('일별 접수 추이')
            );
            
            if (!trendSection) {
                console.error('❌ Could not find trend chart section');
                alert('❌ 일별 접수 추이 섹션을 찾을 수 없습니다');
                return;
            }
            
            // Find the container (should be the parent's next sibling with class p-6)
            const container = trendSection.parentElement.nextElementSibling;
            console.log('Found container:', container);
            
            if (!container) {
                console.error('❌ No container found');
                alert('❌ Container not found');
                return;
            }
            
            // Clear everything and create a simple chart
            console.log('🔧 Clearing container and creating simple chart...');
            
            // Remove all existing content
            container.innerHTML = '';
            
            // Create the chart directly with inline styles for guaranteed visibility
            const chartHTML = `
                <div style="padding: 20px;">
                    <div style="text-align: center; color: #6B7280; font-size: 12px; margin-bottom: 15px;">일별 접수 현황 (강제 수정됨)</div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 14px; font-weight: 500; color: #374151; width: 80px;">9월 17일</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 120px; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden;">
                                <div style="width: 0%; height: 100%; background-color: #8B5CF6; border-radius: 6px;"></div>
                            </div>
                            <span style="font-size: 13px; color: #6B7280; width: 40px; text-align: right;">0건</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 14px; font-weight: 500; color: #374151; width: 80px;">9월 18일</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 120px; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden;">
                                <div style="width: 0%; height: 100%; background-color: #8B5CF6; border-radius: 6px;"></div>
                            </div>
                            <span style="font-size: 13px; color: #6B7280; width: 40px; text-align: right;">0건</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 14px; font-weight: 500; color: #374151; width: 80px;">9월 19일</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 120px; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden;">
                                <div style="width: 0%; height: 100%; background-color: #8B5CF6; border-radius: 6px;"></div>
                            </div>
                            <span style="font-size: 13px; color: #6B7280; width: 40px; text-align: right;">0건</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0; background-color: #F3F4F6;">
                        <span style="font-size: 14px; font-weight: 600; color: #374151; width: 80px;">9월 20일</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 120px; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden;">
                                <div style="width: 100%; height: 100%; background-color: #8B5CF6; border-radius: 6px; transition: width 0.3s ease;"></div>
                            </div>
                            <span style="font-size: 13px; color: #374151; font-weight: 600; width: 40px; text-align: right;">400건</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="font-size: 14px; font-weight: 500; color: #374151; width: 80px;">9월 21일</span>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 120px; height: 12px; background-color: #E5E7EB; border-radius: 6px; overflow: hidden;">
                                <div style="width: 0%; height: 100%; background-color: #8B5CF6; border-radius: 6px;"></div>
                            </div>
                            <span style="font-size: 13px; color: #6B7280; width: 40px; text-align: right;">0건</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = chartHTML;
            console.log('✅ Chart forcefully created');
            alert('✅ 차트가 강제로 생성되었습니다!');
        });

        function exportToCSV(data) {
            const headers = ['접수일시', '채널', '내용', '우선순위', '상태', '분류'];
            const csvContent = [
                headers.join(','),
                ...data.map(item => [
                    new Date(item.createdAt).toLocaleString('ko-KR'),
                    item.channel,
                    `"${(item.maskedContent || item.content).replace(/"/g, '""')}"`,
                    item.priority,
                    item.status,
                    item.classification || ''
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `접수현황_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Manual LLM Analysis Button
        document.getElementById('enableLLMAnalysis').addEventListener('click', async () => {
            const button = document.getElementById('enableLLMAnalysis');
            const originalText = button.textContent;
            
            try {
                button.disabled = true;
                
                // Start countdown timer
                let countdown = 30;
                const countdownInterval = setInterval(() => {
                    button.textContent = `🤖 LLM 분석 중... (${countdown}초 남음)`;
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        button.textContent = '🤖 LLM 분석 중... (완료 대기)';
                    }
                }, 1000);
                
                console.log('🤖 Starting manual LLM analysis...');
                
                // Get current filtered data
                const filters = getFilterValues();
                const filteredData = applyFilters(currentData, filters);
                
                if (filteredData.length === 0) {
                    throw new Error('No data to analyze');
                }
                
                // Call LLM keywords API
                const messages = filteredData.map(item => item.content || item.maskedContent || '').filter(content => content.length > 0);
                
                const llmResponse = await fetch('/api/intake/llm/keywords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messages.slice(0, 30) }) // Limit to 30 for speed
                });
                
                if (!llmResponse.ok) {
                    throw new Error('LLM API failed');
                }
                
                const llmData = await llmResponse.json();
                if (!llmData.success || !llmData.data.keywords) {
                    throw new Error('No LLM keywords returned');
                }
                
                // Update keyword sections with LLM results
                const keywordFrequency = {};
                llmData.data.keywords.forEach(kw => {
                    keywordFrequency[kw.keyword] = kw.count;
                });
                
                console.log('✅ LLM keywords received:', Object.keys(keywordFrequency).length);
                
                // Update displays with LLM indicators
                updateTopKeywords(keywordFrequency);
                updateCategoryKeywords(keywordFrequency);
                
                // Generate AI insights with LLM data
                generateAIInsights(keywordFrequency, filteredData);
                
                // Add LLM indicators to section titles with animation
                const topKeywordsTitle = Array.from(document.querySelectorAll('h3')).find(h3 => h3.textContent.includes('상위 키워드'));
                if (topKeywordsTitle) {
                    topKeywordsTitle.innerHTML = '🤖 상위 키워드 순위 <span class="text-green-600 text-sm font-bold animate-pulse">(LLM 적용됨)</span>';
                    topKeywordsTitle.parentElement.style.border = '2px solid #10B981';
                    topKeywordsTitle.parentElement.style.borderRadius = '8px';
                    topKeywordsTitle.parentElement.style.backgroundColor = '#F0FDF4';
                }
                
                const categoryTitle = Array.from(document.querySelectorAll('h3')).find(h3 => h3.textContent.includes('카테고리별'));
                if (categoryTitle) {
                    categoryTitle.innerHTML = '🤖 카테고리별 주요 키워드 <span class="text-green-600 text-sm font-bold animate-pulse">(LLM 적용됨)</span>';
                    categoryTitle.parentElement.style.border = '2px solid #10B981';
                    categoryTitle.parentElement.style.borderRadius = '8px';
                    categoryTitle.parentElement.style.backgroundColor = '#F0FDF4';
                }
                
                // Add success notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                notification.innerHTML = '🤖 LLM 키워드 분석이 적용되었습니다!';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 5000);
                
                // Update word cloud stats
                const statsDiv = document.getElementById('wordCloudStats');
                if (statsDiv) {
                    const totalWords = Object.keys(keywordFrequency).length;
                    statsDiv.innerHTML = `
                        <div class="flex justify-center space-x-6 text-sm">
                            <span class="text-green-600">🤖 LLM 향상된 분석</span>
                            <span>총 키워드: <strong>${totalWords}개</strong></span>
                            <span>분석 메시지: <strong>${messages.length}개</strong></span>
                        </div>
                    `;
                }
                
                clearInterval(countdownInterval);
                button.textContent = '✅ LLM 분석 완료!';
                button.className = 'bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = 'bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700';
                    button.disabled = false;
                }, 5000);
                
            } catch (error) {
                clearInterval(countdownInterval);
                console.error('Manual LLM analysis failed:', error);
                button.textContent = '❌ LLM 분석 실패';
                button.className = 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = 'bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700';
                    button.disabled = false;
                }, 3000);
            }
        });

        // Unit Analytics Functions
        let currentUnitData = null;
        let currentUnitPage = 1;
        let currentUnitFilters = {};

        // Load unit analytics data
        async function loadUnitAnalytics() {
            try {
                console.log('🏢 Loading unit analytics...');
                
                // Build query parameters from current filters
                const params = new URLSearchParams();
                
                if (currentUnitFilters.startDate) {
                    params.append('startDate', currentUnitFilters.startDate);
                }
                if (currentUnitFilters.endDate) {
                    params.append('endDate', currentUnitFilters.endDate);
                }
                if (currentUnitFilters.categories && currentUnitFilters.categories.length > 0) {
                    params.append('categories', currentUnitFilters.categories.join(','));
                }
                
                const response = await fetch(`/api/reports/units/analytics?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUnitData = data.data;
                    updateUnitAnalyticsDisplay(data.data);
                    console.log('✅ Unit analytics loaded successfully');
                } else {
                    console.error('❌ Failed to load unit analytics:', data.error);
                    showUnitAnalyticsError(data.error);
                }
            } catch (error) {
                console.error('❌ Error loading unit analytics:', error);
                showUnitAnalyticsError('네트워크 오류가 발생했습니다.');
            }
        }

        // Update unit analytics display
        function updateUnitAnalyticsDisplay(data) {
            // Update metrics
            document.getElementById('totalActiveUnits').textContent = data.summary.totalActiveUnits || 0;
            document.getElementById('avgRequestsPerUnit').textContent = data.metrics.averageRequestsPerUnit || 0;
            document.getElementById('mostActiveBuilding').textContent = data.metrics.mostActiveBuilding || 'N/A';
            document.getElementById('peakPeriod').textContent = data.metrics.peakPeriod || 'N/A';

            // Update top units table
            const tableBody = document.getElementById('topUnitsTable');
            const emptyState = document.getElementById('unitsEmptyState');

            if (data.topUnits && data.topUnits.length > 0) {
                tableBody.innerHTML = '';
                emptyState.classList.add('hidden');

                data.topUnits.forEach((unit, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 cursor-pointer';
                    
                    // Format last request date
                    const lastRequestDate = new Date(unit.lastRequestDate);
                    const timeAgo = getTimeAgo(lastRequestDate);
                    
                    // Get category badge color
                    const categoryColor = getCategoryColor(unit.primaryCategory);
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">
                                ${index + 1}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${unit.apartmentUnit.formatted}</div>
                            <div class="text-sm text-gray-500">${unit.apartmentUnit.floor}층</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                ${unit.requestCount}건
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${timeAgo}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${categoryColor}">
                                ${getCategoryDisplayName(unit.primaryCategory)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="unit-detail-btn text-indigo-600 hover:text-indigo-900" 
                                    data-dong="${unit.apartmentUnit.dong}" 
                                    data-ho="${unit.apartmentUnit.ho}">
                                상세 보기
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Add event listeners to the newly created buttons
                addUnitDetailButtonListeners();
            } else {
                tableBody.innerHTML = '';
                emptyState.classList.remove('hidden');
            }
        }
        
        // Add event listeners to unit detail buttons
        function addUnitDetailButtonListeners() {
            const buttons = document.querySelectorAll('.unit-detail-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    const dong = parseInt(this.getAttribute('data-dong'));
                    const ho = parseInt(this.getAttribute('data-ho'));
                    console.log(`🏠 Button clicked for ${dong}동 ${ho}호`);
                    openUnitHistory(dong, ho);
                });
            });
        }

        // Show ticket detail in modal
        async function navigateToTicketDetail(messageId) {
            try {
                console.log(`🎫 Loading ticket detail for message: ${messageId}`);
                
                // Show ticket modal
                const modal = document.getElementById('ticketDetailModal');
                modal.classList.remove('hidden');
                
                // Show loading state
                document.getElementById('ticketModalLoading').classList.remove('hidden');
                document.getElementById('ticketModalDetails').classList.add('hidden');
                document.getElementById('ticketModalError').classList.add('hidden');
                
                // Get ticket ID from message ID
                const response = await fetch(`/api/tickets/by-message/${messageId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const ticketId = data.data.id;
                    
                    // Load full ticket details
                    const ticketResponse = await fetch(`/api/tickets/${ticketId}`);
                    
                    if (ticketResponse.ok) {
                        const ticketData = await ticketResponse.json();
                        displayTicketDetails(ticketData.data, ticketId);
                    } else {
                        showTicketError('티켓 상세 정보를 불러올 수 없습니다.');
                    }
                } else {
                    showTicketError('해당 메시지의 티켓을 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('❌ Error loading ticket detail:', error);
                showTicketError('티켓 정보를 불러오는 중 오류가 발생했습니다.');
            }
        }

        // Display ticket details in modal
        function displayTicketDetails(ticket, ticketId) {
            // Hide loading, show details
            document.getElementById('ticketModalLoading').classList.add('hidden');
            document.getElementById('ticketModalDetails').classList.remove('hidden');
            
            // Update modal title
            document.getElementById('ticketModalTitle').textContent = `티켓 상세 정보 - ${ticket.number}`;
            
            // Update ticket info
            document.getElementById('ticketNumber').textContent = ticket.number;
            document.getElementById('ticketStatus').textContent = getStatusDisplayName(ticket.status);
            document.getElementById('ticketPriority').textContent = getPriorityDisplayName(ticket.priority);
            document.getElementById('ticketCategory').textContent = getCategoryDisplayName(ticket.category);
            
            // Update ticket details
            document.getElementById('ticketTitle').textContent = ticket.title;
            document.getElementById('ticketDescription').textContent = ticket.description;
            document.getElementById('ticketReporter').textContent = ticket.reporterId;
            document.getElementById('ticketCreated').textContent = new Date(ticket.createdAt).toLocaleString('ko-KR');
            
            // Set up full ticket page button
            document.getElementById('openFullTicketBtn').onclick = function() {
                window.open(`/ticket-detail.html?id=${ticketId}`, '_blank');
            };
        }

        // Show ticket error in modal
        function showTicketError(message) {
            document.getElementById('ticketModalLoading').classList.add('hidden');
            document.getElementById('ticketModalDetails').classList.add('hidden');
            document.getElementById('ticketModalError').classList.remove('hidden');
            document.getElementById('ticketErrorMessage').textContent = message;
        }

        // Helper functions for display names
        function getStatusDisplayName(status) {
            const statusMap = {
                'open': '열림',
                'in_progress': '진행중',
                'resolved': '해결됨',
                'closed': '닫힘'
            };
            return statusMap[status] || status;
        }

        function getPriorityDisplayName(priority) {
            const priorityMap = {
                'low': '낮음',
                'medium': '보통',
                'high': '높음',
                'urgent': '긴급'
            };
            return priorityMap[priority] || priority;
        }

        // Show unit analytics error
        function showUnitAnalyticsError(message) {
            const tableBody = document.getElementById('topUnitsTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-red-500">
                        ❌ ${message}
                    </td>
                </tr>
            `;
            
            // Reset metrics
            document.getElementById('totalActiveUnits').textContent = '-';
            document.getElementById('avgRequestsPerUnit').textContent = '-';
            document.getElementById('mostActiveBuilding').textContent = '-';
            document.getElementById('peakPeriod').textContent = '-';
        }

        // Open unit history modal
        async function openUnitHistory(dong, ho) {
            try {
                console.log(`🏠 Opening history for ${dong}동 ${ho}호`);
                
                // Show modal
                const modal = document.getElementById('unitHistoryModal');
                modal.classList.remove('hidden');
                
                // Update modal title
                document.getElementById('modalUnitTitle').textContent = `${dong}동 ${ho}호 접수 이력`;
                
                // Reset pagination
                currentUnitPage = 1;
                
                // Load unit history
                await loadUnitHistory(dong, ho, currentUnitPage);
                
            } catch (error) {
                console.error('❌ Error opening unit history:', error);
                alert('세대 이력을 불러오는 중 오류가 발생했습니다.');
            }
        }

        // Load unit history data
        async function loadUnitHistory(dong, ho, page = 1) {
            try {
                // Build query parameters
                const params = new URLSearchParams();
                params.append('page', page.toString());
                params.append('limit', '10');
                
                if (currentUnitFilters.startDate) {
                    params.append('startDate', currentUnitFilters.startDate);
                }
                if (currentUnitFilters.endDate) {
                    params.append('endDate', currentUnitFilters.endDate);
                }
                if (currentUnitFilters.categories && currentUnitFilters.categories.length > 0) {
                    params.append('categories', currentUnitFilters.categories.join(','));
                }
                
                const response = await fetch(`/api/reports/units/${dong}/${ho}/history?${params}`);
                const data = await response.json();
                
                if (data.success) {
                    updateUnitHistoryDisplay(data.data);
                } else {
                    console.error('❌ Failed to load unit history:', data.error);
                    showUnitHistoryError(data.error);
                }
            } catch (error) {
                console.error('❌ Error loading unit history:', error);
                showUnitHistoryError('네트워크 오류가 발생했습니다.');
            }
        }

        // Update unit history modal display
        function updateUnitHistoryDisplay(data) {
            // Update unit info
            document.getElementById('modalDong').textContent = data.unit.dong + '동';
            document.getElementById('modalHo').textContent = data.unit.ho + '호';
            document.getElementById('modalFloor').textContent = data.unit.floor + '층';
            document.getElementById('modalTotalRequests').textContent = data.totalRequests + '건';
            
            // Update history table
            const tableBody = document.getElementById('modalHistoryTable');
            
            if (data.requests && data.requests.length > 0) {
                tableBody.innerHTML = '';
                
                data.requests.forEach(request => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-blue-50 cursor-pointer transition-colors duration-200';
                    row.setAttribute('data-message-id', request.id);
                    
                    // Format date
                    const requestDate = new Date(request.createdAt);
                    const formattedDate = requestDate.toLocaleDateString('ko-KR', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Get channel icon
                    const channelIcon = getChannelIcon(request.channel);
                    
                    // Get category color
                    const categoryColor = getCategoryColor(request.classification);
                    
                    // Get status color
                    const statusColor = getStatusColor(request.status);
                    
                    // Truncate content
                    const truncatedContent = request.maskedContent.length > 50 
                        ? request.maskedContent.substring(0, 50) + '...'
                        : request.maskedContent;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center">
                                ${channelIcon} ${getChannelDisplayName(request.channel)}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${categoryColor}">
                                ${getCategoryDisplayName(request.classification)}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${getStatusDisplayName(request.status)}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600" title="${request.maskedContent}">
                            ${truncatedContent}
                            <div class="text-xs text-blue-600 mt-1">🔍 클릭하여 티켓 상세보기</div>
                        </td>
                    `;
                    
                    // Add click handler to navigate to ticket detail
                    row.addEventListener('click', function() {
                        navigateToTicketDetail(request.id);
                    });
                    
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500">
                            해당 기간에 접수된 이력이 없습니다.
                        </td>
                    </tr>
                `;
            }
            
            // Update pagination
            updateUnitHistoryPagination(data.pagination);
        }

        // Update unit history pagination
        function updateUnitHistoryPagination(pagination) {
            const pageInfo = document.getElementById('modalPageInfo');
            const prevButton = document.getElementById('modalPrevPage');
            const nextButton = document.getElementById('modalNextPage');
            
            pageInfo.textContent = `${pagination.page} / ${pagination.totalPages} 페이지 (총 ${pagination.total}건)`;
            
            prevButton.disabled = pagination.page <= 1;
            nextButton.disabled = pagination.page >= pagination.totalPages;
            
            currentUnitPage = pagination.page;
        }

        // Show unit history error
        function showUnitHistoryError(message) {
            const tableBody = document.getElementById('modalHistoryTable');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-4 py-4 text-center text-red-500">
                        ❌ ${message}
                    </td>
                </tr>
            `;
        }

        // Export unit analytics
        async function exportUnitAnalytics() {
            try {
                console.log('📊 Exporting unit analytics...');
                
                // Build query parameters
                const params = new URLSearchParams();
                params.append('format', 'csv');
                
                if (currentUnitFilters.startDate) {
                    params.append('startDate', currentUnitFilters.startDate);
                }
                if (currentUnitFilters.endDate) {
                    params.append('endDate', currentUnitFilters.endDate);
                }
                if (currentUnitFilters.categories && currentUnitFilters.categories.length > 0) {
                    params.append('categories', currentUnitFilters.categories.join(','));
                }
                
                // Create download link
                const url = `/api/reports/units/export?${params}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = `unit-analytics-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('✅ Unit analytics export initiated');
                
            } catch (error) {
                console.error('❌ Error exporting unit analytics:', error);
                alert('데이터 내보내기 중 오류가 발생했습니다.');
            }
        }

        // Helper functions
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 60) {
                return `${diffMins}분 전`;
            } else if (diffHours < 24) {
                return `${diffHours}시간 전`;
            } else if (diffDays < 7) {
                return `${diffDays}일 전`;
            } else {
                return date.toLocaleDateString('ko-KR');
            }
        }

        function getCategoryColor(category) {
            const colors = {
                'noise': 'bg-red-100 text-red-800',
                'maintenance': 'bg-yellow-100 text-yellow-800',
                'parking': 'bg-blue-100 text-blue-800',
                'billing': 'bg-green-100 text-green-800',
                'inquiry': 'bg-purple-100 text-purple-800',
                'unknown': 'bg-gray-100 text-gray-800'
            };
            return colors[category] || colors['unknown'];
        }

        function getCategoryDisplayName(category) {
            const names = {
                'noise': '소음',
                'maintenance': '시설관리',
                'parking': '주차',
                'billing': '관리비',
                'inquiry': '문의',
                'unknown': '기타'
            };
            return names[category] || '기타';
        }

        function getStatusColor(status) {
            const colors = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'classified': 'bg-blue-100 text-blue-800',
                'assigned': 'bg-purple-100 text-purple-800',
                'processed': 'bg-green-100 text-green-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusDisplayName(status) {
            const names = {
                'pending': '대기중',
                'classified': '분류완료',
                'assigned': '할당됨',
                'processed': '처리완료'
            };
            return names[status] || status;
        }

        function getChannelIcon(channel) {
            const icons = {
                'sms': '📱',
                'email': '📧',
                'web': '🌐',
                'call': '📞'
            };
            return icons[channel] || '📝';
        }

        function getChannelDisplayName(channel) {
            const names = {
                'sms': 'SMS',
                'email': '이메일',
                'web': '웹폼',
                'call': '통화'
            };
            return names[channel] || channel;
        }

        // Event listeners for unit analytics
        document.getElementById('exportUnits').addEventListener('click', exportUnitAnalytics);
        
        // Test modal button
        document.getElementById('testModalBtn').addEventListener('click', function() {
            openUnitHistory(101, 1502);
        });
        
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('unitHistoryModal').classList.add('hidden');
        });

        // Ticket modal event listeners
        document.getElementById('closeTicketModal').addEventListener('click', function() {
            document.getElementById('ticketDetailModal').classList.add('hidden');
        });

        document.getElementById('closeTicketModalBtn').addEventListener('click', function() {
            document.getElementById('ticketDetailModal').classList.add('hidden');
        });

        document.getElementById('closeTicketErrorBtn').addEventListener('click', function() {
            document.getElementById('ticketDetailModal').classList.add('hidden');
        });
        
        document.getElementById('modalPrevPage').addEventListener('click', function() {
            if (currentUnitPage > 1) {
                const modal = document.getElementById('unitHistoryModal');
                const unitTitle = document.getElementById('modalUnitTitle').textContent;
                const matches = unitTitle.match(/(\d+)동 (\d+)호/);
                if (matches) {
                    loadUnitHistory(parseInt(matches[1]), parseInt(matches[2]), currentUnitPage - 1);
                }
            }
        });
        
        document.getElementById('modalNextPage').addEventListener('click', function() {
            const modal = document.getElementById('unitHistoryModal');
            const unitTitle = document.getElementById('modalUnitTitle').textContent;
            const matches = unitTitle.match(/(\d+)동 (\d+)호/);
            if (matches) {
                loadUnitHistory(parseInt(matches[1]), parseInt(matches[2]), currentUnitPage + 1);
            }
        });

        // Close modal when clicking outside
        document.getElementById('unitHistoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });

        // Update unit analytics when filters change
        function updateUnitFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            currentUnitFilters = {
                startDate: startDate || null,
                endDate: endDate || null,
                categories: [] // Will be populated based on classification filters if needed
            };
            
            // Reload unit analytics with new filters
            loadUnitAnalytics();
        }

        // Integrate with existing filter system
        // Hook into the existing filter button click instead of overriding applyFilters
        const applyFiltersButton = document.getElementById('applyFilters');
        if (applyFiltersButton) {
            applyFiltersButton.addEventListener('click', function() {
                // Wait a bit for the original filters to be applied, then update unit filters
                setTimeout(() => {
                    updateUnitFilters();
                }, 100);
            });
        }

        // Load unit analytics on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for other components to load
            setTimeout(() => {
                loadUnitAnalytics();
            }, 1000);
        });

        // Also load when data is refreshed
        const loadDataButton = document.getElementById('loadData');
        if (loadDataButton) {
            loadDataButton.addEventListener('click', function() {
                // Wait for the original data to load, then update unit analytics
                setTimeout(() => {
                    loadUnitAnalytics();
                }, 1000);
            });
        }
    </script>
</body>
</html>