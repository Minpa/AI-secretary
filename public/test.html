<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Secretary - ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-white text-xl font-bold">AI Secretary</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">í™ˆ</a>
                    <a href="/dashboard" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">ëŒ€ì‹œë³´ë“œ</a>
                    <a href="/reports" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">ë¦¬í¬íŠ¸</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900">ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
            <p class="mt-2 text-gray-600">AI Secretaryì˜ ë‹¤ì–‘í•œ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- SMS Test -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“± SMS ì ‘ìˆ˜ í…ŒìŠ¤íŠ¸</h2>
                <form id="smsForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°œì‹ ë²ˆí˜¸</label>
                        <input type="text" id="smsFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="010-1234-5678" value="010-1234-5678">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€ ë‚´ìš©</label>
                        <textarea id="smsBody" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                                  placeholder="ì—˜ë¦¬ë² ì´í„°ê°€ ê³ ì¥ë‚¬ì–´ìš”">ì—˜ë¦¬ë² ì´í„°ê°€ ê³ ì¥ë‚¬ì–´ìš”</textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        SMS ì „ì†¡ í…ŒìŠ¤íŠ¸
                    </button>
                </form>
                <div id="smsResult" class="mt-4 hidden"></div>
            </div>

            <!-- Email Test -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“§ ì´ë©”ì¼ ì ‘ìˆ˜ í…ŒìŠ¤íŠ¸</h2>
                <form id="emailForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°œì‹ ì</label>
                        <input type="email" id="emailFrom" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="resident@example.com" value="resident@example.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì œëª©</label>
                        <input type="text" id="emailSubject" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="ì†ŒìŒ ë¯¼ì›" value="ì†ŒìŒ ë¯¼ì›">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë‚´ìš©</label>
                        <textarea id="emailBody" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                                  placeholder="ìœ—ì§‘ ì†ŒìŒì´ ì‹¬í•©ë‹ˆë‹¤">ìœ—ì§‘ ì†ŒìŒì´ ì‹¬í•©ë‹ˆë‹¤</textarea>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">
                        ì´ë©”ì¼ ì „ì†¡ í…ŒìŠ¤íŠ¸
                    </button>
                </form>
                <div id="emailResult" class="mt-4 hidden"></div>
            </div>

            <!-- Web Form Test -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸŒ ì›¹í¼ ì ‘ìˆ˜ í…ŒìŠ¤íŠ¸</h2>
                <form id="webForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
                        <input type="text" id="webName" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="í™ê¸¸ë™" value="í™ê¸¸ë™">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼</label>
                        <input type="email" id="webEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="hong@example.com" value="hong@example.com">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë¬¸ì˜ ë‚´ìš©</label>
                        <textarea id="webMessage" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                                  placeholder="ì£¼ì°¨ì¥ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤">ì£¼ì°¨ì¥ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤</textarea>
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                        ì›¹í¼ ì œì¶œ í…ŒìŠ¤íŠ¸
                    </button>
                </form>
                <div id="webResult" class="mt-4 hidden"></div>
            </div>

            <!-- Call Test -->
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“ í†µí™” ê¸°ë¡ í…ŒìŠ¤íŠ¸</h2>
                <form id="callForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ë°œì‹ ë²ˆí˜¸</label>
                        <input type="text" id="callCaller" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="010-9876-5432" value="010-9876-5432">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">í†µí™” ì‹œê°„ (ë¶„)</label>
                        <input type="number" id="callDuration" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                               placeholder="5" value="5">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">í†µí™” ë‚´ìš© (ìŒì„±ì¸ì‹)</label>
                        <textarea id="callTranscript" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                                  placeholder="ê´€ë¦¬ë¹„ ë¬¸ì˜ë“œë¦½ë‹ˆë‹¤">ê´€ë¦¬ë¹„ ë¬¸ì˜ë“œë¦½ë‹ˆë‹¤</textarea>
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">
                        í†µí™” ê¸°ë¡ í…ŒìŠ¤íŠ¸
                    </button>
                </form>
                <div id="callResult" class="mt-4 hidden"></div>
            </div>
        </div>

        <!-- LLM Management Section -->
        <div class="mt-8 bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ¤– LLM ê´€ë¦¬</h2>
            <p class="text-sm text-gray-600 mb-6">ë¡œì»¬ Mistral-7B ëª¨ë¸ ì œì–´ ë° í…ŒìŠ¤íŠ¸</p>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- LLM Status & Control -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-3">ìƒíƒœ ë° ì œì–´</h3>
                    
                    <!-- Status Display -->
                    <div id="llmStatus" class="p-4 bg-gray-50 rounded-md mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium">ìƒíƒœ:</span>
                            <span id="llmStatusText" class="text-gray-600">í™•ì¸ ì¤‘...</span>
                        </div>
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium">ëª¨ë¸:</span>
                            <span id="llmModel" class="text-gray-600">-</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-medium">ì‚¬ìš© ê°€ëŠ¥:</span>
                            <span id="llmAvailable" class="text-gray-600">-</span>
                        </div>
                    </div>

                    <!-- LLM Toggle -->
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-md mb-4">
                        <div>
                            <h4 class="font-medium text-blue-900">LLM ë¶„ë¥˜ ì‚¬ìš©</h4>
                            <p class="text-sm text-blue-700">ì‹ ë¢°ë„ ë‚®ì„ ë•Œ LLM ì‚¬ìš©</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="llmToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <button id="refreshLLMStatus" class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">
                        ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>

                <!-- LLM Test -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-3">LLM ë¶„ë¥˜ í…ŒìŠ¤íŠ¸</h3>
                    <textarea 
                        id="llmTestText" 
                        rows="4" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4"
                        placeholder="ë¶„ë¥˜í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    >ìœ—ì§‘ì—ì„œ ë„ˆë¬´ ì‹œë„ëŸ¬ì›Œìš”. ë°¤ëŠ¦ê²Œê¹Œì§€ ì¿µì¿µê±°ë¦¬ëŠ” ì†Œë¦¬ê°€ ë‚˜ì„œ ì ì„ ì˜ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</textarea>
                    
                    <button id="testLLM" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 mb-2">
                        ğŸ¤– LLM ë¶„ë¥˜ í…ŒìŠ¤íŠ¸
                    </button>
                    
                    <button id="testLLMKeywords" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 mb-4">
                        ğŸ” LLM í‚¤ì›Œë“œ ë¶„ì„
                    </button>
                    
                    <div id="llmTestResult" class="hidden"></div>
                    <div id="llmKeywordsResult" class="hidden"></div>
                </div>
            </div>
        </div>

        <!-- Message Status Management -->
        <div class="mt-8 bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ“‹ ë©”ì‹œì§€ ìƒíƒœ ê´€ë¦¬</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Get Messages -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-3">ë©”ì‹œì§€ ëª©ë¡ ì¡°íšŒ</h3>
                    <button id="getMessages" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 mb-4">
                        ë©”ì‹œì§€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <div id="messagesResult" class="hidden"></div>
                </div>

                <!-- Update Status -->
                <div>
                    <h3 class="text-lg font-medium text-gray-900 mb-3">ìƒíƒœ ì—…ë°ì´íŠ¸</h3>
                    <form id="statusUpdateForm">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë©”ì‹œì§€ ID</label>
                            <input type="text" id="messageId" class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                                   placeholder="msg_1234567890_abcdef">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìƒˆ ìƒíƒœ</label>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <input type="radio" id="statusPending" name="newStatus" value="pending" class="mr-2">
                                    <label for="statusPending" class="text-sm text-gray-700">ëŒ€ê¸°ì¤‘ (pending)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="statusClassified" name="newStatus" value="classified" class="mr-2">
                                    <label for="statusClassified" class="text-sm text-gray-700">ë¶„ë¥˜ì™„ë£Œ (classified)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="statusAssigned" name="newStatus" value="assigned" class="mr-2">
                                    <label for="statusAssigned" class="text-sm text-gray-700">í• ë‹¹ë¨ (assigned)</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="statusProcessed" name="newStatus" value="processed" class="mr-2">
                                    <label for="statusProcessed" class="text-sm text-gray-700">ì²˜ë¦¬ì™„ë£Œ (processed)</label>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700">
                            ìƒíƒœ ì—…ë°ì´íŠ¸
                        </button>
                    </form>
                    <div id="statusUpdateResult" class="mt-4 hidden"></div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="mt-8 bg-white shadow rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ</h2>
            <button id="healthCheck" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700">
                í—¬ìŠ¤ ì²´í¬
            </button>
            <div id="healthResult" class="mt-4 hidden"></div>
        </div>
    </div>

    <script>
        // Helper function to display results
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = `mt-4 p-4 rounded-md ${isError ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}`;
            element.innerHTML = `<pre class="text-sm ${isError ? 'text-red-800' : 'text-green-800'}">${JSON.stringify(data, null, 2)}</pre>`;
            element.classList.remove('hidden');
        }

        // SMS Form
        document.getElementById('smsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/api/intake/sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: document.getElementById('smsFrom').value,
                        body: document.getElementById('smsBody').value
                    })
                });
                const data = await response.json();
                displayResult('smsResult', data, !response.ok);
            } catch (error) {
                displayResult('smsResult', { error: error.message }, true);
            }
        });

        // Email Form
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/api/intake/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        from: document.getElementById('emailFrom').value,
                        subject: document.getElementById('emailSubject').value,
                        body: document.getElementById('emailBody').value
                    })
                });
                const data = await response.json();
                displayResult('emailResult', data, !response.ok);
            } catch (error) {
                displayResult('emailResult', { error: error.message }, true);
            }
        });

        // Web Form
        document.getElementById('webForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/api/intake/web', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('webName').value,
                        email: document.getElementById('webEmail').value,
                        message: document.getElementById('webMessage').value
                    })
                });
                const data = await response.json();
                displayResult('webResult', data, !response.ok);
            } catch (error) {
                displayResult('webResult', { error: error.message }, true);
            }
        });

        // Call Form
        document.getElementById('callForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch('/api/intake/call', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        caller: document.getElementById('callCaller').value,
                        duration: parseInt(document.getElementById('callDuration').value),
                        transcript: document.getElementById('callTranscript').value
                    })
                });
                const data = await response.json();
                displayResult('callResult', data, !response.ok);
            } catch (error) {
                displayResult('callResult', { error: error.message }, true);
            }
        });

        // Get Messages
        document.getElementById('getMessages').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/intake/messages');
                const data = await response.json();
                displayResult('messagesResult', data, !response.ok);
            } catch (error) {
                displayResult('messagesResult', { error: error.message }, true);
            }
        });

        // Status Update Form
        document.getElementById('statusUpdateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const messageId = document.getElementById('messageId').value;
                const newStatus = document.querySelector('input[name="newStatus"]:checked')?.value;

                if (!messageId || !newStatus) {
                    displayResult('statusUpdateResult', { error: 'ë©”ì‹œì§€ IDì™€ ìƒíƒœë¥¼ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.' }, true);
                    return;
                }

                const response = await fetch(`/api/intake/messages/${messageId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const data = await response.json();
                displayResult('statusUpdateResult', data, !response.ok);
            } catch (error) {
                displayResult('statusUpdateResult', { error: error.message }, true);
            }
        });

        // Health Check
        document.getElementById('healthCheck').addEventListener('click', async () => {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                displayResult('healthResult', data, !response.ok);
            } catch (error) {
                displayResult('healthResult', { error: error.message }, true);
            }
        });

        // LLM Management Functions
        async function loadLLMStatus() {
            try {
                const response = await fetch('/api/intake/llm/status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data;
                    document.getElementById('llmStatusText').textContent = status.enabled ? 'í™œì„±í™”ë¨' : 'ë¹„í™œì„±í™”ë¨';
                    document.getElementById('llmModel').textContent = status.config.model || '-';
                    document.getElementById('llmAvailable').textContent = status.available ? 'âœ… ì‚¬ìš© ê°€ëŠ¥' : 'âŒ ì‚¬ìš© ë¶ˆê°€';
                    document.getElementById('llmToggle').checked = status.enabled;
                    
                    // Update status color
                    const statusEl = document.getElementById('llmStatusText');
                    statusEl.className = status.enabled && status.available ? 'text-green-600 font-medium' : 'text-red-600 font-medium';
                } else {
                    document.getElementById('llmStatusText').textContent = 'ì˜¤ë¥˜';
                    document.getElementById('llmStatusText').className = 'text-red-600 font-medium';
                }
            } catch (error) {
                console.error('Failed to load LLM status:', error);
                document.getElementById('llmStatusText').textContent = 'ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('llmStatusText').className = 'text-red-600 font-medium';
            }
        }

        // LLM Toggle
        document.getElementById('llmToggle').addEventListener('change', async (e) => {
            const enabled = e.target.checked;
            
            try {
                const response = await fetch('/api/intake/llm/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await loadLLMStatus(); // Refresh status
                    alert(`LLM ì„œë¹„ìŠ¤ê°€ ${enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    e.target.checked = !enabled; // Revert toggle
                    alert('LLM ì„¤ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                e.target.checked = !enabled; // Revert toggle
                alert('LLM ì„¤ì • ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        });

        // LLM Test
        document.getElementById('testLLM').addEventListener('click', async () => {
            const text = document.getElementById('llmTestText').value.trim();
            
            if (!text) {
                alert('í…ŒìŠ¤íŠ¸í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/api/intake/llm/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                
                const data = await response.json();
                displayResult('llmTestResult', data, !response.ok);
            } catch (error) {
                displayResult('llmTestResult', { error: error.message }, true);
            }
        });

        // Refresh LLM Status
        document.getElementById('refreshLLMStatus').addEventListener('click', loadLLMStatus);

        // Load LLM status on page load
        loadLLMStatus();
            document.getElementById('enableLLMAnalysis').addEventListener('click', async () => {
                const button = document.getElementById('enableLLMAnalysis');
                const originalText = button.textContent;
                
                try {
                    button.textContent = 'ğŸ¤– LLM ë¶„ì„ ì¤‘... (30ì´ˆ ëŒ€ê¸°)';
                    button.disabled = true;
                    
                    // Force enable LLM for this analysis
                    const filteredData = applyFilters(currentData, getFilterValues());
                    
                    // Temporarily enable LLM
                    const originalUpdateWordCloud = updateWordCloud;
                    window.updateWordCloud = async function(data) {
                        // Force LLM analysis
                        const useLLM = true;
                        let keywordFrequency = {};
                        let analysisMethod = 'basic';
                        
                        if (useLLM) {
                            try {
                                console.log('ğŸ¤– Manual LLM keyword extraction...');
                                const messages = data.map(item => item.content || item.maskedContent || '').filter(content => content.length > 0);
                                
                                const llmResponse = await fetch('/api/intake/llm/keywords', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ messages: messages.slice(0, 30) })
                                });
                                
                                if (llmResponse.ok) {
                                    const llmData = await llmResponse.json();
                                    if (llmData.success && llmData.data.keywords) {
                                        llmData.data.keywords.forEach(kw => {
                                            keywordFrequency[kw.keyword] = kw.count;
                                        });
                                        analysisMethod = 'llm-enhanced';
                                        console.log('âœ… Manual LLM analysis complete');
                                    }
                                }
                            } catch (error) {
                                console.log('âŒ Manual LLM failed:', error);
                            }
                        }
                        
                        // Update displays with LLM results
                        if (Object.keys(keywordFrequency).length > 0) {
                            updateTopKeywords(keywordFrequency);
                            updateCategoryKeywords(keywordFrequency);
                            
                            // Update word cloud stats
                            const statsDiv = document.getElementById('wordCloudStats');
                            if (statsDiv) {
                                const totalWords = Object.keys(keywordFrequency).length;
                                const methodIndicator = 'ğŸ¤– LLM í–¥ìƒëœ ë¶„ì„';
                                statsDiv.innerHTML = `
                                    <div class="flex justify-center space-x-6 text-sm">
                                        <span class="text-green-600">${methodIndicator}</span>
                                        <span>ì´ í‚¤ì›Œë“œ: <strong>${totalWords}ê°œ</strong></span>
                                    </div>
                                `;
                            }
                        }
                    };
                    
                    await updateWordCloud(filteredData);
                    
                    // Restore original function
                    window.updateWordCloud = originalUpdateWordCloud;
                    
                    button.textContent = 'âœ… LLM ë¶„ì„ ì™„ë£Œ';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 3000);
                    
                } catch (error) {
                    console.error('Manual LLM analysis failed:', error);
                    button.textContent = 'âŒ LLM ë¶„ì„ ì‹¤íŒ¨';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 3000);
                }
            });
        }

        // Test LLM Keywords
        document.getElementById('testLLMKeywords').addEventListener('click', async () => {
            try {
                // Get sample messages
                const response = await fetch('/api/intake/messages?limit=50');
                const data = await response.json();
                
                if (!data.success) {
                    alert('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨: ' + data.error);
                    return;
                }

                const messages = data.data.map(msg => msg.content || msg.maskedContent);
                
                const keywordResponse = await fetch('/api/intake/llm/keywords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages })
                });
                
                const keywordData = await keywordResponse.json();
                displayResult('llmKeywordsResult', keywordData, !keywordResponse.ok);
            } catch (error) {
                displayResult('llmKeywordsResult', { error: error.message }, true);
            }
        });
    </script>
</body>
</html>