<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Secretary - í‹°ì¼“ ìƒì„¸</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/" class="text-white text-xl font-bold">AI Secretary</a>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">í™ˆ</a>
                    <a href="/dashboard.html" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">ëŒ€ì‹œë³´ë“œ</a>
                    <a href="/reports.html" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">ë¦¬í¬íŠ¸</a>
                    <a href="/workload.html" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">ì—…ë¬´ ë¶„ë‹´</a>
                    <a href="/test.html" class="text-white hover:text-gray-200 px-3 py-2 rounded-md">í…ŒìŠ¤íŠ¸</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">í‹°ì¼“ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center py-12">
            <div class="text-red-600 text-6xl mb-4">âš ï¸</div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">í‹°ì¼“ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
            <p class="text-gray-600 mb-4">ìš”ì²­í•˜ì‹  í‹°ì¼“ì´ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <a href="/dashboard" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            </a>
        </div>

        <!-- Ticket Detail Content -->
        <div id="ticketContent" class="hidden">
            <!-- Header -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 id="ticketTitle" class="text-2xl font-bold text-gray-900"></h1>
                            <p class="text-sm text-gray-500 mt-1">
                                í‹°ì¼“ ë²ˆí˜¸: <span id="ticketNumber" class="font-medium"></span>
                            </p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <span id="priorityBadge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"></span>
                            <span id="statusBadge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Ticket Info Grid -->
                <div class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ì¹´í…Œê³ ë¦¬</dt>
                            <dd id="ticketCategory" class="mt-1 text-sm text-gray-900"></dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ì‹ ê³ ì</dt>
                            <dd id="ticketReporter" class="mt-1 text-sm text-gray-900"></dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ìƒì„±ì¼ì‹œ</dt>
                            <dd id="ticketCreated" class="mt-1 text-sm text-gray-900"></dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">SLA ë§ˆê°</dt>
                            <dd id="ticketSLA" class="mt-1 text-sm"></dd>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignee Management -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">ğŸ‘¤ ë‹´ë‹¹ì ê´€ë¦¬</h2>
                </div>
                <div class="px-6 py-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <dt class="text-sm font-medium text-gray-500 mb-2">í˜„ì¬ ë‹´ë‹¹ì</dt>
                            <div id="currentAssignee" class="flex items-center space-x-3 p-3 bg-gray-50 rounded-md">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-medium">
                                    <span id="assigneeInitial">-</span>
                                </div>
                                <div>
                                    <div id="assigneeName" class="font-medium text-gray-900">ë¯¸í• ë‹¹</div>
                                    <div id="assigneeRole" class="text-sm text-gray-500">-</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500 mb-2">ë‹´ë‹¹ì ë³€ê²½</dt>
                            <div class="space-y-3">
                                <select id="assigneeSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                                <button id="updateAssigneeBtn" class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                                    ë‹´ë‹¹ì ë³€ê²½
                                </button>
                                <div id="assigneeUpdateResult" class="hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">ìƒì„¸ ë‚´ìš©</h2>
                </div>
                <div class="px-6 py-4">
                    <div id="ticketDescription" class="prose max-w-none text-gray-700 whitespace-pre-wrap"></div>
                </div>
            </div>

            <!-- Status Management -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">ìƒíƒœ ê´€ë¦¬</h2>
                </div>
                <div class="px-6 py-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="flex items-center">
                            <input type="radio" id="statusOpen" name="ticketStatus" value="open" class="mr-2">
                            <label for="statusOpen" class="text-sm text-gray-700">ì—´ë¦¼</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="statusInProgress" name="ticketStatus" value="in_progress" class="mr-2">
                            <label for="statusInProgress" class="text-sm text-gray-700">ì§„í–‰ì¤‘</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="statusResolved" name="ticketStatus" value="resolved" class="mr-2">
                            <label for="statusResolved" class="text-sm text-gray-700">í•´ê²°ë¨</label>
                        </div>
                        <div class="flex items-center">
                            <input type="radio" id="statusClosed" name="ticketStatus" value="closed" class="mr-2">
                            <label for="statusClosed" class="text-sm text-gray-700">ë‹«í˜</label>
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="updateStatusBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                            ìƒíƒœ ì—…ë°ì´íŠ¸
                        </button>
                        <div id="statusUpdateResult" class="mt-2 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Related Message -->
            <div class="bg-white shadow rounded-lg mb-6">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">ê´€ë ¨ ì ‘ìˆ˜ ë©”ì‹œì§€</h2>
                </div>
                <div class="px-6 py-4">
                    <div id="relatedMessage" class="space-y-3">
                        <div class="flex items-center space-x-2">
                            <span id="messageChannel" class="text-2xl"></span>
                            <span id="messageChannelText" class="text-sm font-medium text-gray-900"></span>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ì›ë³¸ ë‚´ìš©</dt>
                            <dd id="messageContent" class="mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md whitespace-pre-wrap"></dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">ë§ˆìŠ¤í‚¹ëœ ë‚´ìš©</dt>
                            <dd id="messageMasked" class="mt-1 text-sm text-gray-900 bg-gray-50 p-3 rounded-md whitespace-pre-wrap"></dd>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-between">
                <a href="/dashboard" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700">
                    â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </a>
                <div class="space-x-2">
                    <button id="refreshBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get ticket ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const ticketId = urlParams.get('id');

        if (!ticketId) {
            showError();
        } else {
            loadTicketDetail(ticketId);
        }

        async function loadTicketDetail(ticketId) {
            try {
                // Load ticket details
                const ticketResponse = await fetch(`/api/tickets/${ticketId}`);
                if (!ticketResponse.ok) {
                    throw new Error('Ticket not found');
                }
                const ticketData = await ticketResponse.json();
                
                if (!ticketData.success) {
                    throw new Error('Failed to load ticket');
                }

                const ticket = ticketData.data;

                // Load related message
                const messageResponse = await fetch(`/api/intake/messages/${ticket.intakeMessageId}`);
                let message = null;
                if (messageResponse.ok) {
                    const messageData = await messageResponse.json();
                    if (messageData.success) {
                        message = messageData.data;
                    }
                }

                displayTicketDetail(ticket, message);
                
            } catch (error) {
                console.error('Error loading ticket:', error);
                showError();
            }
        }

        function displayTicketDetail(ticket, message) {
            // Hide loading state
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('ticketContent').classList.remove('hidden');

            // Basic info
            document.getElementById('ticketTitle').textContent = ticket.title;
            document.getElementById('ticketNumber').textContent = ticket.number;
            document.getElementById('ticketDescription').textContent = ticket.description;

            // Categories and labels
            const categoryLabels = {
                'maintenance': 'ì‹œì„¤ê´€ë¦¬',
                'noise': 'ì†ŒìŒ',
                'parking': 'ì£¼ì°¨',
                'billing': 'ê´€ë¦¬ë¹„',
                'security': 'ë³´ì•ˆ',
                'emergency': 'ì‘ê¸‰',
                'complaint': 'ë¯¼ì›',
                'inquiry': 'ë¬¸ì˜'
            };

            document.getElementById('ticketCategory').textContent = categoryLabels[ticket.category] || ticket.category;
            document.getElementById('ticketReporter').textContent = ticket.reporterId;
            document.getElementById('ticketCreated').textContent = new Date(ticket.createdAt).toLocaleString('ko-KR');

            // SLA deadline
            const slaElement = document.getElementById('ticketSLA');
            const slaDeadline = new Date(ticket.slaDeadline);
            const now = new Date();
            const isOverdue = now > slaDeadline;
            
            slaElement.textContent = slaDeadline.toLocaleString('ko-KR');
            slaElement.className = `mt-1 text-sm ${isOverdue ? 'text-red-600 font-medium' : 'text-gray-900'}`;
            if (isOverdue) {
                slaElement.textContent += ' (ì§€ì—°)';
            }

            // Priority badge
            const priorityColors = {
                'urgent': 'bg-red-100 text-red-800',
                'high': 'bg-orange-100 text-orange-800',
                'medium': 'bg-yellow-100 text-yellow-800',
                'low': 'bg-green-100 text-green-800'
            };
            const priorityBadge = document.getElementById('priorityBadge');
            priorityBadge.textContent = ticket.priority;
            priorityBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${priorityColors[ticket.priority] || 'bg-gray-100 text-gray-800'}`;

            // Status badge
            const statusColors = {
                'open': 'bg-blue-100 text-blue-800',
                'in_progress': 'bg-purple-100 text-purple-800',
                'pending': 'bg-yellow-100 text-yellow-800',
                'resolved': 'bg-green-100 text-green-800',
                'closed': 'bg-gray-100 text-gray-800'
            };
            const statusLabels = {
                'open': 'ì—´ë¦¼',
                'in_progress': 'ì§„í–‰ì¤‘',
                'pending': 'ëŒ€ê¸°',
                'resolved': 'í•´ê²°ë¨',
                'closed': 'ë‹«í˜'
            };
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = statusLabels[ticket.status] || ticket.status;
            statusBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${statusColors[ticket.status] || 'bg-gray-100 text-gray-800'}`;

            // Set current status in radio buttons
            const statusRadio = document.querySelector(`input[name="ticketStatus"][value="${ticket.status}"]`);
            if (statusRadio) {
                statusRadio.checked = true;
            }

            // Related message
            if (message) {
                const channelEmojis = {
                    'sms': 'ğŸ“±',
                    'email': 'ğŸ“§',
                    'web': 'ğŸŒ',
                    'call': 'ğŸ“'
                };
                const channelLabels = {
                    'sms': 'SMS',
                    'email': 'ì´ë©”ì¼',
                    'web': 'ì›¹í¼',
                    'call': 'í†µí™”'
                };

                document.getElementById('messageChannel').textContent = channelEmojis[message.channel] || 'ğŸ“';
                document.getElementById('messageChannelText').textContent = channelLabels[message.channel] || message.channel;
                document.getElementById('messageContent').textContent = message.content;
                document.getElementById('messageMasked').textContent = message.maskedContent;
            }

            // Load and display assignee information
            loadAssigneeInfo(ticket.assigneeId);
        }

        async function loadAssigneeInfo(assigneeId) {
            try {
                // Load staff list for dropdown
                const staffResponse = await fetch('/api/tickets/staff');
                if (staffResponse.ok) {
                    const staffData = await staffResponse.json();
                    if (staffData.success) {
                        populateAssigneeDropdown(staffData.data, assigneeId);
                        displayCurrentAssignee(staffData.data, assigneeId);
                    }
                }
            } catch (error) {
                console.error('Error loading assignee info:', error);
            }
        }

        function populateAssigneeDropdown(staffList, currentAssigneeId) {
            const select = document.getElementById('assigneeSelect');
            select.innerHTML = '<option value="">ë‹´ë‹¹ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
            
            staffList.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                option.textContent = `${staff.name} (${staff.role})`;
                if (staff.id === currentAssigneeId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function displayCurrentAssignee(staffList, assigneeId) {
            const assignee = staffList.find(staff => staff.id === assigneeId);
            
            if (assignee) {
                document.getElementById('assigneeInitial').textContent = assignee.name.charAt(0);
                document.getElementById('assigneeName').textContent = assignee.name;
                document.getElementById('assigneeRole').textContent = assignee.role;
            } else {
                document.getElementById('assigneeInitial').textContent = '?';
                document.getElementById('assigneeName').textContent = 'ë¯¸í• ë‹¹';
                document.getElementById('assigneeRole').textContent = 'ë‹´ë‹¹ìê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';
            }
        }

        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }

        // Status update functionality
        document.getElementById('updateStatusBtn').addEventListener('click', async () => {
            const selectedStatus = document.querySelector('input[name="ticketStatus"]:checked')?.value;
            if (!selectedStatus) {
                alert('ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/tickets/${ticketId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: selectedStatus })
                });

                const result = await response.json();
                const resultDiv = document.getElementById('statusUpdateResult');
                
                if (response.ok && result.success) {
                    resultDiv.className = 'mt-2 p-3 bg-green-50 border border-green-200 rounded-md';
                    resultDiv.innerHTML = '<p class="text-sm text-green-800">ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                    
                    // Refresh the page after a short delay
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    resultDiv.className = 'mt-2 p-3 bg-red-50 border border-red-200 rounded-md';
                    resultDiv.innerHTML = '<p class="text-sm text-red-800">ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                
                resultDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error updating status:', error);
                alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Assignee update functionality
        document.getElementById('updateAssigneeBtn').addEventListener('click', async () => {
            const selectedAssigneeId = document.getElementById('assigneeSelect').value;
            if (!selectedAssigneeId) {
                alert('ë‹´ë‹¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/tickets/${ticketId}/reassign`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assigneeId: selectedAssigneeId })
                });

                const result = await response.json();
                const resultDiv = document.getElementById('assigneeUpdateResult');
                
                if (response.ok && result.success) {
                    resultDiv.className = 'p-3 bg-green-50 border border-green-200 rounded-md';
                    resultDiv.innerHTML = '<p class="text-sm text-green-800">ë‹´ë‹¹ìê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                    
                    // Refresh assignee display
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    resultDiv.className = 'p-3 bg-red-50 border border-red-200 rounded-md';
                    resultDiv.innerHTML = '<p class="text-sm text-red-800">ë‹´ë‹¹ì ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
                }
                
                resultDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error updating assignee:', error);
                alert('ë‹´ë‹¹ì ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', () => {
            location.reload();
        });
    </script>
</body>
</html>